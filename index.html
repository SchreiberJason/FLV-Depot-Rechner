<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Finanzplan | Jason Schreiber</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Inter+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â• TOKENS â•â•â•â•â•â•â•â•â•â• */
:root {
  --sp:#0F0F0F; --ss:#16171B; --st:#282930;
  --bp:#38D9A3; --bh:#2FC493; --bpr:#1C8764;
  --brd:#212430; --tp:#F0EDE8; --ts:#969696; --tm:#555860;
  --ac:#38D9A3; --adim:rgba(56,217,163,0.08); --adim2:rgba(56,217,163,0.16);
  --sh:rgba(0,0,0,0.45); color-scheme:dark;
}
@media(prefers-color-scheme:light){
  :root{
    --sp:#EDEBE5; --ss:#F7F2EA; --st:#FFFEFC;
    --bp:#039F6B; --bh:#2FC493; --bpr:#1C8764;
    --brd:#DDD8CF; --tp:#1A1A1A; --ts:#969696; --tm:#AAAAAA;
    --ac:#039F6B; --adim:rgba(3,159,107,0.08); --adim2:rgba(3,159,107,0.15);
    --sh:rgba(0,0,0,0.07); color-scheme:light;
  }
}

/* â•â•â•â•â•â•â•â•â•â• RESET â•â•â•â•â•â•â•â•â•â• */
*{box-sizing:border-box;margin:0;padding:0;}
html{-webkit-text-size-adjust:100%;scroll-behavior:smooth;}
body{
  background:var(--sp); color:var(--tp);
  font-family:'Inter Display','Inter',sans-serif;
  font-size:15px; line-height:1.6;
  min-height:100vh; overflow-x:hidden;
}

/* â•â•â•â•â•â•â•â•â•â• VIEWS â•â•â•â•â•â•â•â•â•â• */
.view{display:none;}
.view.active{display:block;}

/* â•â•â•â•â•â•â•â•â•â• BACK NAV â•â•â•â•â•â•â•â•â•â• */
.back-nav{
  max-width:1240px; margin:0 auto;
  padding:env(safe-area-inset-top,16px) 16px 0;
  padding-top:max(16px, env(safe-area-inset-top));
  display:flex; align-items:center; gap:10px;
}
.back-btn{
  background:none; border:1px solid var(--brd); border-radius:10px;
  padding:0 14px; height:40px; color:var(--ts);
  font-family:inherit; font-size:13px; font-weight:600;
  cursor:pointer; display:flex; align-items:center; gap:7px;
  transition:all .15s; -webkit-tap-highlight-color:transparent;
}
.back-btn:hover,.back-btn:active{border-color:var(--ac);color:var(--ac);background:var(--adim);}
.back-crumb{font-size:12px;color:var(--tm);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.back-crumb b{color:var(--ts);font-weight:500;}

/* â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â• */
.dash-wrap{max-width:1240px;margin:0 auto;padding:28px 0 80px;}

.dash-header{margin-bottom:28px;}
.dash-eyebrow{
  display:inline-flex;align-items:center;gap:7px;
  font-size:10px;font-weight:700;letter-spacing:.16em;text-transform:uppercase;
  color:var(--ac);margin-bottom:12px;
}
.dash-title{font-size:clamp(26px,6vw,46px);font-weight:700;letter-spacing:-.03em;line-height:1.08;color:var(--tp);margin-bottom:10px;}
.dash-sub{font-size:14px;color:var(--ts);line-height:1.7;max-width:500px;}

/* Summary strip */
.dash-summary{
  display:grid; grid-template-columns:repeat(3,1fr);
  gap:1px; background:var(--brd);
  border:1px solid var(--brd); border-radius:14px;
  overflow:hidden; margin-bottom:24px;
}
.ds-item{background:var(--ss);padding:18px 16px;text-align:center;}
.ds-label{font-size:9.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ts);margin-bottom:6px;}
.ds-value{font-size:clamp(14px,3vw,20px);font-weight:700;letter-spacing:-.02em;color:var(--tp);}
.ds-value.ac{color:var(--ac);}

/* Pillar grid */
.pillar-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}

.pillar-card{
  background:var(--ss); border:1px solid var(--brd); border-radius:16px;
  overflow:hidden; cursor:pointer;
  transition:border-color .2s,transform .15s,box-shadow .15s;
  box-shadow:0 4px 20px var(--sh); display:flex; flex-direction:column;
  -webkit-tap-highlight-color:transparent;
}
.pillar-card:hover{border-color:var(--ac);transform:translateY(-2px);box-shadow:0 8px 28px var(--sh),0 0 0 1px var(--adim2);}
.pillar-card:active{transform:translateY(0);}
.pc-top{padding:22px 20px 0;flex:1;}
.pc-badge{
  display:inline-flex;align-items:center;gap:6px;
  font-size:9.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;
  padding:4px 10px;border-radius:100px;margin-bottom:14px;
}
.pc-badge.kurz  {background:rgba(251,191,36,.12);color:#fbbf24;}
.pc-badge.mittel{background:rgba(96,165,250,.12);color:#60a5fa;}
.pc-badge.lang  {background:var(--adim2);color:var(--ac);}
.pc-title{font-size:18px;font-weight:700;letter-spacing:-.015em;margin-bottom:7px;color:var(--tp);}
.pc-desc{font-size:12px;color:var(--ts);line-height:1.65;margin-bottom:16px;}
.pc-metrics{
  display:grid;grid-template-columns:1fr 1fr;
  gap:1px;background:var(--brd);border-top:1px solid var(--brd);
}
.pc-metric{background:var(--st);padding:13px 16px;}
.pcm-label{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--tm);margin-bottom:4px;}
.pcm-value{font-size:14px;font-weight:700;letter-spacing:-.01em;color:var(--tp);}
.pcm-value.y{color:#fbbf24;}
.pcm-value.b{color:#60a5fa;}
.pcm-value.a{color:var(--ac);}
.pc-cta{
  display:flex;align-items:center;justify-content:space-between;
  padding:13px 20px;background:none;border-top:1px solid var(--brd);
  font-size:12px;font-weight:600;color:var(--ac);transition:background .15s;
}
.pillar-card:hover .pc-cta{background:var(--adim);}
.cta-arr{font-size:13px;transition:transform .15s;}
.pillar-card:hover .cta-arr{transform:translateX(4px);}

/* â•â•â•â•â•â•â•â•â•â• CALC LAYOUT â•â•â•â•â•â•â•â•â•â• */
.calc-layout{
  max-width:1240px; margin:0 auto;
  padding:20px 16px 80px;
  display:grid; grid-template-columns:320px 1fr;
  gap:20px; align-items:start;
}

/* â•â•â•â•â•â•â•â•â•â• PARAMS PANEL â•â•â•â•â•â•â•â•â•â• */
.params-panel{
  background:var(--ss); border:1px solid var(--brd); border-radius:14px;
  overflow:hidden; position:sticky; top:16px;
  max-height:calc(100vh - 80px); overflow-y:auto;
  box-shadow:0 4px 20px var(--sh);
}

.ps{padding:16px 18px;border-bottom:1px solid var(--brd);}
.ps:last-child{border-bottom:none;}
.sl{font-size:10px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--ac);margin-bottom:12px;}

/* Mode toggle */
.mode-toggle{
  display:grid;grid-template-columns:1fr 1fr;
  gap:2px;background:var(--st);border-radius:10px;overflow:hidden;
  margin-bottom:0;
}
.mode-btn{
  background:none;border:none;padding:10px 8px;
  font-family:inherit;font-size:12.5px;font-weight:600;
  color:var(--ts);cursor:pointer;
  transition:all .15s;text-align:center;
  -webkit-tap-highlight-color:transparent;
}
.mode-btn.on{background:var(--ss);color:var(--ac);border-radius:8px;box-shadow:0 1px 4px var(--sh);}

/* Collapsible */
.ct{
  display:flex;align-items:center;justify-content:space-between;
  cursor:pointer;user-select:none;
  padding:14px 18px;border-bottom:1px solid var(--brd);
  transition:background .15s;
  -webkit-tap-highlight-color:transparent;
}
.ct:hover,.ct:active{background:var(--adim);}
.ct .sl{margin-bottom:0;}
.ca{color:var(--tm);font-size:9px;transition:transform .22s;flex-shrink:0;}
.ct.open .ca{transform:rotate(180deg);}
.cb{display:none;padding:14px 18px;border-bottom:1px solid var(--brd);}
.cb.open{display:block;}

/* Fields */
.f{margin-bottom:12px;}
.f:last-child{margin-bottom:0;}
label{display:block;font-size:11.5px;font-weight:500;color:var(--ts);margin-bottom:5px;}

input[type="number"],input[type="text"],select{
  width:100%;background:var(--st);border:1px solid var(--brd);border-radius:8px;
  color:var(--tp);font-family:inherit;
  /* font-size 16px prevents iOS zoom */
  font-size:16px;
  padding:9px 12px;outline:none;transition:border-color .15s;
}
input[type="number"],input[type="text"]{-moz-appearance:textfield;appearance:none;}
@media(min-width:640px){input[type="number"],input[type="text"],select{font-size:14px;}}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none;}
input:focus,select:focus{border-color:var(--ac);background:var(--adim);}
select{cursor:pointer;}
select option{background:var(--ss);}

.fu{display:flex;}
.fu input,.fu select{border-radius:8px 0 0 8px;border-right:none;}
.ub{
  background:var(--sp);border:1px solid var(--brd);border-left:none;
  border-radius:0 8px 8px 0;padding:0 10px;
  font-size:11px;font-weight:500;color:var(--tm);
  white-space:nowrap;display:flex;align-items:center;
}

/* Einmal rows */
.er{display:grid;grid-template-columns:1fr 1fr 38px;gap:6px;margin-bottom:6px;align-items:end;}
.btn-rm{
  background:none;border:1px solid var(--brd);color:var(--tm);
  border-radius:7px;width:38px;height:42px;cursor:pointer;
  font-size:17px;display:flex;align-items:center;justify-content:center;
  transition:all .13s;-webkit-tap-highlight-color:transparent;
}
.btn-rm:active{border-color:#f87171;color:#f87171;background:rgba(248,113,113,.08);}
.btn-add{
  background:none;border:1px dashed var(--brd);color:var(--ts);
  border-radius:8px;padding:9px;width:100%;cursor:pointer;
  font-size:12.5px;font-family:inherit;font-weight:500;
  transition:all .13s;margin-top:4px;
  -webkit-tap-highlight-color:transparent;
}
.btn-add:active{border-color:var(--ac);color:var(--ac);background:var(--adim);}

.btn-calc{
  width:100%;background:var(--bp);color:#051a10;border:none;border-radius:10px;
  padding:13px;font-family:inherit;font-size:13px;font-weight:700;
  letter-spacing:.07em;text-transform:uppercase;cursor:pointer;
  transition:background .13s,transform .1s,box-shadow .13s;
  min-height:48px;-webkit-tap-highlight-color:transparent;
}
.btn-calc:hover{background:var(--bh);transform:translateY(-1px);box-shadow:0 6px 18px rgba(56,217,163,.22);}
.btn-calc:active{background:var(--bpr);transform:translateY(0);box-shadow:none;}

/* â•â•â•â•â•â•â•â•â•â• RESULTS â•â•â•â•â•â•â•â•â•â• */
.rp{display:flex;flex-direction:column;gap:16px;}

.card{background:var(--ss);border:1px solid var(--brd);border-radius:14px;overflow:hidden;box-shadow:0 2px 10px var(--sh);}
.ch{padding:14px 18px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;}
.ct-title{font-weight:600;font-size:14px;color:var(--tp);}
.cb2{padding:18px;}

.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}

.met{background:var(--ss);border:1px solid var(--brd);border-radius:14px;padding:16px;box-shadow:0 2px 10px var(--sh);}
.met.hi{border-color:var(--ac);background:var(--adim);}
.mi{font-size:16px;margin-bottom:7px;display:block;}
.ml{font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--ts);margin-bottom:6px;}
.mv{font-weight:700;font-size:clamp(18px,4vw,24px);letter-spacing:-.02em;line-height:1;margin-bottom:4px;color:var(--tp);}
.mv.green{color:#4ade80;}
.mv.blue{color:#60a5fa;}
.mv.ac{color:var(--ac);}
.mv.pos{color:#4ade80;}
.mv.neg{color:#f87171;}
.ms{font-size:11px;color:var(--ts);line-height:1.5;}

/* Progress */
.pw{background:var(--st);border-radius:100px;height:8px;overflow:hidden;margin:10px 0 4px;}
.pf{height:100%;border-radius:100px;background:var(--ac);transition:width .4s ease;}

/* Legend */
.legend{display:flex;flex-wrap:wrap;gap:5px;}
.li{
  display:flex;align-items:center;gap:6px;padding:5px 10px;
  border:1px solid var(--brd);border-radius:100px;cursor:pointer;
  font-size:11px;font-weight:500;color:var(--ts);background:var(--st);
  user-select:none;transition:all .13s;-webkit-tap-highlight-color:transparent;
}
.li.on{color:var(--tp);border-color:transparent;}
.li.off{opacity:.32;}
.ld{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.chart-box{padding:16px 8px 10px;height:300px;}

/* Table */
.tw{overflow-x:auto;max-height:280px;overflow-y:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;font-size:12px;}
thead th{padding:9px 12px;text-align:right;font-size:9.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ts);background:var(--st);border-bottom:1px solid var(--brd);position:sticky;top:0;white-space:nowrap;}
thead th:first-child{text-align:center;}
tbody td{padding:9px 12px;text-align:right;border-bottom:1px solid var(--brd);font-variant-numeric:tabular-nums;color:var(--ts);}
tbody td:first-child{text-align:center;color:var(--tm);font-weight:600;}
tbody tr:last-child td{border-bottom:none;}
@media(hover:hover){tbody tr:hover td{background:var(--adim);color:var(--tp);}}

/* Info box */
.ib{background:var(--adim);border:1px solid rgba(56,217,163,.18);border-radius:10px;padding:11px 13px;font-size:12px;color:var(--ts);line-height:1.6;margin-top:8px;}
.ib b,.ib strong{color:var(--ac);}

/* Toggle pill for optional tagesgeld */
.opt-toggle{
  display:flex;align-items:center;justify-content:space-between;
  gap:10px;padding:12px 18px;border-bottom:1px solid var(--brd);
  cursor:pointer;-webkit-tap-highlight-color:transparent;
}
.opt-label{font-size:10px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--ts);}
.opt-pill{
  position:relative;width:36px;height:20px;border-radius:100px;
  background:var(--st);border:1px solid var(--brd);
  transition:background .2s,border-color .2s;flex-shrink:0;cursor:pointer;
}
.opt-pill::after{
  content:'';position:absolute;top:2px;left:2px;
  width:14px;height:14px;border-radius:50%;background:var(--tm);
  transition:transform .2s,background .2s;
}
.opt-pill.on{background:var(--adim2);border-color:var(--ac);}
.opt-pill.on::after{transform:translateX(16px);background:var(--ac);}

.hidden{display:none!important;}

/* â•â•â•â•â•â•â•â•â•â• SCROLLBAR â•â•â•â•â•â•â•â•â•â• */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--brd);border-radius:3px;}

/* â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â• */

/* ---- Tablet 600â€“1023px ---- */
@media(min-width:600px) and (max-width:1023px){
  .dash-wrap{padding:24px 0 60px;}
  .pillar-grid{grid-template-columns:1fr 1fr;gap:12px;}
  .pillar-grid>.pillar-card:last-child{grid-column:1/-1;}
  .calc-layout{
    grid-template-columns:1fr;
    padding:16px 20px 60px;
    gap:16px;
  }
  .params-panel{position:static;max-height:none;overflow-y:visible;}
  /* On tablet, params and results side-by-side if wide enough */
}
@media(min-width:720px) and (max-width:1023px){
  .calc-layout{
    grid-template-columns:300px 1fr;
    gap:16px;
  }
  .params-panel{position:sticky;top:16px;max-height:calc(100vh - 80px);overflow-y:auto;}
  .g3{grid-template-columns:1fr 1fr;}
}
@media(min-width:600px) and (max-width:719px){
  .g2,.g3{grid-template-columns:1fr 1fr;}
}

/* ---- Mobile <600px ---- */
@media(max-width:599px){
  body{font-size:14px;}
  .back-nav{padding:14px 14px 0;}
  .dash-wrap{padding:20px 0 56px;}
  .dash-summary{grid-template-columns:1fr 1fr;gap:1px;}
  .dash-summary .ds-item:nth-child(3){grid-column:1/-1;border-top:1px solid var(--brd);}
  .ds-item{padding:14px 12px;}
  .pillar-grid{grid-template-columns:1fr;gap:10px;}
  /* No hover lift on mobile */
  .pillar-card:hover{transform:none;border-color:var(--brd);box-shadow:0 4px 20px var(--sh);}
  .calc-layout{
    grid-template-columns:1fr;
    padding:14px 14px 64px;
    gap:14px;
  }
  .params-panel{position:static;max-height:none;overflow-y:visible;}
  .g2,.g3{grid-template-columns:1fr 1fr;}
  .mv{font-size:20px;}
  .chart-box{height:240px;padding:12px 4px 8px;}
  .ps{padding:14px;}
  .ct,.opt-toggle{padding:12px 14px;}
  .cb{padding:12px 14px;}
}
@media(max-width:399px){
  .g2,.g3{grid-template-columns:1fr;}
  .pc-metrics{grid-template-columns:1fr 1fr;}
}

/* ---- Large desktop â‰¥1024px ---- */
@media(min-width:1024px){
  .dash-wrap{padding:40px 0 80px;}
  .back-nav{padding:20px 28px 0;}
  .calc-layout{
    grid-template-columns:330px 1fr;
    padding:24px 28px 80px;
    gap:24px;
  }
  .g3{grid-template-columns:repeat(3,1fr);}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view active" id="view-dash">
<div class="dash-wrap">

  <div class="dash-summary">
    <div class="ds-item">
      <div class="ds-label">ğŸ¦ Notgroschen-Ziel</div>
      <div class="ds-value ac" id="dash-k">â€”</div>
    </div>
    <div class="ds-item">
      <div class="ds-label">ğŸ¯ Mittelfrist</div>
      <div class="ds-value" id="dash-m" style="color:var(--ts)">â€”</div>
    </div>
    <div class="ds-item">
      <div class="ds-label">ğŸ“ˆ FLV Netto</div>
      <div class="ds-value" id="dash-l" style="color:var(--ts)">â€”</div>
    </div>
  </div>

  <div class="pillar-grid">

    <div class="pillar-card" onclick="goTo('kurz')">
      <div class="pc-top">
        <div class="pc-badge kurz">ğŸ¦ Kurzfristig Â· &lt;1 Jahr</div>
        <div class="pc-title">Notgroschen</div>
        <div class="pc-desc">Dein finanzielles Sicherheitsnetz fÃ¼r unerwartete Ausgaben. Sofort verfÃ¼gbar auf Tagesgeld. Empfohlen: 3â€“6 MonatsgehÃ¤lter.</div>
      </div>
      <div class="pc-metrics">
        <div class="pc-metric"><div class="pcm-label">Ziel-Betrag</div><div class="pcm-value y" id="dk-ziel">â€”</div></div>
        <div class="pc-metric"><div class="pcm-label">Dauer bis Ziel</div><div class="pcm-value y" id="dk-dauer">â€”</div></div>
      </div>
      <div class="pc-cta">Rechner Ã¶ffnen <span class="cta-arr">â†’</span></div>
    </div>

    <div class="pillar-card" onclick="goTo('mittel')">
      <div class="pc-top">
        <div class="pc-badge mittel">ğŸ¯ Mittelfristig Â· 2â€“10 J.</div>
        <div class="pc-title">Zielsparen</div>
        <div class="pc-desc">FÃ¼r konkrete Lebensziele oder freies Ansparen. Mit Fondssparplan erreichst du mehr. Ziel oder freies Sparen wÃ¤hlbar.</div>
      </div>
      <div class="pc-metrics">
        <div class="pc-metric"><div class="pcm-label">Endgewinn</div><div class="pcm-value b" id="dm-fonds">â€”</div></div>
        <div class="pc-metric"><div class="pcm-label">Zinsgewinn</div><div class="pcm-value b" id="dm-delta">â€”</div></div>
      </div>
      <div class="pc-cta">Rechner Ã¶ffnen <span class="cta-arr">â†’</span></div>
    </div>

    <div class="pillar-card" onclick="goTo('lang')">
      <div class="pc-top">
        <div class="pc-badge lang">ğŸ“ˆ Langfristig Â· 20â€“40 J.</div>
        <div class="pc-title">Pensionsvorsorge</div>
        <div class="pc-desc">FLV vs. Flatex Depot im Direktvergleich â€” mit allen Kosten, Steuern und Break-even-Analyse.</div>
      </div>
      <div class="pc-metrics">
        <div class="pc-metric"><div class="pcm-label">Endbetrag FLV</div><div class="pcm-value a" id="dl-flv">â€”</div></div>
        <div class="pc-metric"><div class="pcm-label">FLV-Vorteil</div><div class="pcm-value a" id="dl-depot">â€”</div></div>
      </div>
      <div class="pc-cta">Rechner Ã¶ffnen <span class="cta-arr">â†’</span></div>
    </div>

  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     KURZFRISTIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view" id="view-kurz">
<div class="back-nav">
  <button class="back-btn" onclick="goTo('dash')">â† ZurÃ¼ck</button>
  <span class="back-crumb">Finanzplan / <b>Notgroschen</b></span>
</div>
<div class="calc-layout">

  <aside class="params-panel">
    <div class="ps">
      <div class="sl">Meine Situation</div>
      <div class="f"><label>Monatliches Nettoeinkommen</label>
        <div class="fu"><input type="number" id="k_eink" value="2500" min="0" step="100" oninput="berechneKurz()"><span class="ub">â‚¬ / Mo.</span></div></div>
      <div class="f"><label>Bereits vorhandenes Erspartes</label>
        <div class="fu"><input type="number" id="k_vorh" value="0" min="0" step="100" oninput="berechneKurz()"><span class="ub">â‚¬</span></div></div>
      <div class="f"><label>Monatliche Sparrate</label>
        <div class="fu"><input type="number" id="k_rate" value="300" min="0" step="50" oninput="berechneKurz()"><span class="ub">â‚¬ / Mo.</span></div></div>
    </div>
    <div class="ps">
      <div class="sl">Notgroschen-Ziel</div>
      <div class="f"><label>Absicherung in MonatsgehÃ¤ltern</label>
        <div class="fu"><input type="number" id="k_mo" value="3" min="1" max="12" step="1" oninput="berechneKurz()"><span class="ub">Monate</span></div></div>
    </div>
    <div class="ps">
      <div class="sl">Konto & Zinsen</div>
      <div class="f"><label>Kontotyp</label>
        <div class="fu"><select id="k_typ" onchange="updateKontoHint();berechneKurz()">
          <option value="tagesgeld">Tagesgeldkonto</option>
          <option value="festgeld">Festgeld</option>
          <option value="sparkonto">Sparkonto</option>
          <option value="girokonto">Girokonto (0%)</option>
        </select></div></div>
      <div class="f"><label>Zinssatz p.a.</label>
        <div class="fu"><input type="number" id="k_zins" value="3.0" min="0" max="20" step="0.1" oninput="berechneKurz()"><span class="ub">%&nbsp;p.a.</span></div></div>
      <div class="ib" id="k_hint">Tagesgeld: tÃ¤glich verfÃ¼gbar, 2â€“4 % p.a. â€” ideal fÃ¼r den Notgroschen.</div>
    </div>
    <div class="ps">
      <button class="btn-calc" onclick="berechneKurz()">Berechnen</button>
    </div>
  </aside>

  <div class="rp">
    <div class="g3">
      <div class="met hi"><span class="mi">ğŸ¯</span><div class="ml">Notgroschen-Ziel</div><div class="mv ac" id="k_ziel">â€”</div><div class="ms" id="k_zsub">â€”</div></div>
      <div class="met"><span class="mi">ğŸ“…</span><div class="ml">Dauer bis Ziel</div><div class="mv" id="k_dauer">â€”</div><div class="ms" id="k_dsub">â€”</div></div>
      <div class="met"><span class="mi">ğŸ’°</span><div class="ml">Zinsertrag</div><div class="mv green" id="k_zins_val">â€”</div><div class="ms">bis zum Ziel</div></div>
    </div>

    <div class="card">
      <div class="ch"><span class="ct-title">Aufbau des Notgroschens</span></div>
      <div class="cb2">
        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--ts);margin-bottom:4px">
          <span id="k_ps">Vorhanden: 0 â‚¬</span><span id="k_pe">Ziel: â€” â‚¬</span>
        </div>
        <div class="pw"><div class="pf" id="k_pb" style="width:0%"></div></div>
        <div style="font-size:11px;color:var(--tm);text-align:right;margin-top:3px" id="k_pp">0 % erreicht</div>
        <div class="chart-box" style="height:220px;margin-top:12px"><canvas id="kurzChart"></canvas></div>
      </div>
    </div>

    <div class="card">
      <div class="ch"><span class="ct-title">Monatsplan bis zum Ziel</span></div>
      <div class="tw">
        <table>
          <thead><tr><th>Monat</th><th>Sparrate</th><th>Zinsen</th><th>Kapital</th><th>Bis Ziel</th></tr></thead>
          <tbody id="k_tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MITTELFRISTIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view" id="view-mittel">
<div class="back-nav">
  <button class="back-btn" onclick="goTo('dash')">â† ZurÃ¼ck</button>
  <span class="back-crumb">Finanzplan / <b>Zielsparen</b></span>
</div>
<div class="calc-layout">

  <aside class="params-panel">

    <!-- Mode toggle -->
    <div class="ps">
      <div class="sl">Modus wÃ¤hlen</div>
      <div class="mode-toggle">
        <button class="mode-btn on" id="mb-frei" onclick="setMode('frei')">ğŸ“ˆ Freies Sparen</button>
        <button class="mode-btn" id="mb-ziel" onclick="setMode('ziel')">ğŸ¯ Zielsparen</button>
      </div>
    </div>

    <!-- â”€â”€ ZIELSPAREN â”€â”€ -->
    <div id="ziel-fields" class="hidden">
      <div class="ps">
        <div class="sl">Mein Sparziel</div>
        <div class="f"><label>Bezeichnung</label>
          <input type="text" id="m_name" value="Eigenkapital Hauskauf" oninput="berechneMittel()"></div>
        <div class="f"><label>Zielbetrag</label>
          <div class="fu"><input type="number" id="m_ziel" value="50000" min="0" step="1000" oninput="berechneMittel()"><span class="ub">â‚¬</span></div></div>
        <div class="f"><label>Laufzeit</label>
          <div class="fu"><input type="number" id="m_jahre" value="7" min="1" max="30" oninput="berechneMittel()"><span class="ub">Jahre</span></div></div>
        <div class="f"><label>Startkapital</label>
          <div class="fu"><input type="number" id="m_start" value="5000" min="0" step="500" oninput="berechneMittel()"><span class="ub">â‚¬</span></div></div>
      </div>
      <div class="ps">
        <div class="sl">Sparrate</div>
        <div class="fu"><input type="number" id="m_rate" value="500" min="0" step="50" oninput="berechneMittel()"><span class="ub">â‚¬ / Mo.</span></div>
        <div class="ib" id="m_hint" style="margin-top:10px">BenÃ¶tigte Sparrate wird automatisch berechnet.</div>
      </div>
    </div>

    <!-- â”€â”€ FREIES SPAREN â”€â”€ -->
    <div id="frei-fields">
      <div class="ps">
        <div class="sl">Sparplan</div>
        <div class="f"><label>Laufzeit</label>
          <div class="fu"><input type="number" id="mf_jahre" value="7" min="1" max="30" oninput="berechneMittel()"><span class="ub">Jahre</span></div></div>
        <div class="f"><label>Startkapital</label>
          <div class="fu"><input type="number" id="mf_start" value="5000" min="0" step="500" oninput="berechneMittel()"><span class="ub">â‚¬</span></div></div>
        <div class="f"><label>Monatliche Sparrate</label>
          <div class="fu"><input type="number" id="mf_rate" value="500" min="0" step="50" oninput="berechneMittel()"><span class="ub">â‚¬ / Mo.</span></div></div>
      </div>
    </div>

    <!-- Depotanbieter collapsible -->
    <div class="ct" onclick="toggleColl(this)" id="ct-m-depot">
      <div class="sl">Depotanbieter</div><span class="ca">â–¼</span>
    </div>
    <div class="cb" id="cb-m-depot">
      <div style="padding:14px 18px 10px">
        <div class="mode-toggle" style="margin-bottom:10px">
          <button class="mode-btn on" id="mpb-fonds" onclick="setMittelProdType('fonds')">ğŸ“ˆ Investmentfonds</button>
          <button class="mode-btn" id="mpb-etf" onclick="setMittelProdType('etf')">ğŸ“Š ETF</button>
        </div>
        <select id="m_anbieter" onchange="setMittelAnbieter()">
          <option value="manuell">Manuell</option>
          <option value="flatex">Flatex AT</option>
          <option value="traderepublic">Trade Republic</option>
          <option value="dadat">Dadat</option>
          <option value="easybank">Easybank</option>
          <option value="bks">BKS Bank</option>
          <option value="erste">Erste Bank / George</option>
          <option value="raiffeisen">Raiffeisen Wien</option>
          <option value="bankaustr">Bank Austria</option>
          <option value="bawag">BAWAG P.S.K.</option>
          <option value="plattform" selected>die Plattform</option>
        </select>
        <div class="ib hidden" id="m_anbieter_info" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- Fonds params collapsible -->
    <div class="ct" onclick="toggleColl(this)" id="ct-fonds">
      <div class="sl">Fonds-Parameter</div><span class="ca">â–¼</span>
    </div>
    <div class="cb" id="cb-fonds">
      <div class="f"><label>Agio</label>
        <div class="fu"><input type="number" id="m_agio" value="0" min="0" step="0.1" oninput="berechneMittel()"><span class="ub">%</span></div></div>
      <div class="f"><label>DepotgebÃ¼hr p.a.</label>
        <div class="fu"><input type="number" id="m_depotgeb" value="0" min="0" step="0.01" oninput="berechneMittel()"><span class="ub">% p.a.</span></div></div>
      <div class="f"><label>Rendite p.a.</label>
        <div class="fu"><input type="number" id="m_rendite" value="7" min="0" max="30" step="0.5" oninput="berechneMittel()"><span class="ub">% p.a.</span></div></div>
      <div class="f"><label>TER p.a.</label>
        <div class="fu"><input type="number" id="m_ter" value="0.3" min="0" step="0.01" oninput="berechneMittel()"><span class="ub">% p.a.</span></div></div>
      <div class="f"><label>OrdergebÃ¼hr Sparplan</label>
        <div class="fu"><input type="number" id="m_order" value="0" min="0" step="0.10" oninput="berechneMittel()"><span class="ub">â‚¬ / Order</span></div></div>
      <div class="f"><label>KESt bei Entnahme</label>
        <div class="fu"><input type="number" id="m_kest" value="27.5" min="0" max="100" step="0.5" oninput="berechneMittel()"><span class="ub">%</span></div></div>
      <div class="f"><label>Dividendenrendite p.a.</label>
        <div class="fu"><input type="number" id="m_ddiv" value="2" min="0" step="0.1" oninput="berechneMittel()"><span class="ub">% p.a.</span></div></div>
      <div class="f"><label>Anteil AgE</label>
        <div class="fu"><input type="number" id="m_dage" value="100" min="0" max="100" step="1" oninput="berechneMittel()"><span class="ub">%</span></div></div>
      <div class="f"><label>Spread An-/Verkauf</label>
        <div class="fu"><input type="number" id="m_spread" value="0" min="0" step="0.01" oninput="berechneMittel()"><span class="ub">%</span></div></div>
    </div>

    <!-- Sonderzahlungen collapsible (Mittelfristig) -->
    <div class="ct" onclick="toggleColl(this)" id="ct-m-sonder">
      <div class="sl">Sonderzahlungen</div><span class="ca">â–¼</span>
    </div>
    <div class="cb" id="cb-m-sonder">
      <div class="opt-toggle" onclick="toggleMReg()" style="border-top:none">
        <span class="opt-label">ğŸ”„ RegelmÃ¤ÃŸige Einmalzahlung</span>
        <div class="opt-pill" id="mreg-pill"></div>
      </div>
      <div id="mreg-fields" class="hidden">
        <div style="padding:4px 18px 14px">
          <div class="f"><label>Betrag</label>
            <div class="fu"><input type="number" id="m_reg_betrag" value="1000" min="0" step="100" oninput="mRegBetrag=+this.value;berechneMittel()"><span class="ub">â‚¬</span></div></div>
          <div class="f"><label>Alle X Jahre</label>
            <div class="fu"><input type="number" id="m_reg_int" value="1" min="1" step="1" oninput="mRegIntervall=+this.value;berechneMittel()"><span class="ub">J.</span></div></div>
          <div class="f"><label>Ab Jahr</label>
            <div class="fu"><input type="number" id="m_reg_ab" value="1" min="0" step="1" oninput="mRegAbJahr=+this.value;berechneMittel()"><span class="ub">J.</span></div></div>
        </div>
      </div>
    </div>

    <!-- Tagesgeld OPTIONAL toggle -->
    <div class="opt-toggle" onclick="toggleTages()">
      <span class="opt-label">âš–ï¸ Tagesgeld-Vergleich</span>
      <div class="opt-pill" id="tages-pill"></div>
    </div>
    <div id="tages-fields" class="hidden">
      <div class="cb open" style="border-top:none">
        <div class="f"><label>Zinssatz p.a.</label>
          <div class="fu"><input type="number" id="m_tzins" value="3.0" min="0" max="20" step="0.1" oninput="berechneMittel()"><span class="ub">% p.a.</span></div></div>
        <div class="f"><label>KESt auf Zinsen</label>
          <div class="fu"><input type="number" id="m_tkest" value="27.5" min="0" max="100" step="0.5" oninput="berechneMittel()"><span class="ub">%</span></div></div>
      </div>
    </div>

    <div class="ps">
      <button class="btn-calc" onclick="berechneMittel()">Berechnen</button>
    </div>
  </aside>

  <div class="rp" id="m_results"></div>

</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LANGFRISTIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view" id="view-lang">
<div class="back-nav">
  <button class="back-btn" onclick="goTo('dash')">â† ZurÃ¼ck</button>
  <span class="back-crumb">Finanzplan / <b>Pensionsvorsorge</b></span>
</div>
<div class="calc-layout">

  <aside class="params-panel">
    <div class="ps">
      <div class="sl">Allgemeine Parameter</div>
      <div class="f"><label>Monatliche Sparrate</label>
        <div class="fu"><input type="number" id="l_mb" value="100" min="1" step="10"><span class="ub">â‚¬ / Mo.</span></div></div>
      <div class="f"><label>Laufzeit</label>
        <div class="fu"><input type="number" id="l_lj" value="40" min="1" max="50"><span class="ub">Jahre</span></div></div>
      <div class="f"><label>Marktrendite p.a.</label>
        <div class="fu"><input type="number" id="l_rpa" value="7" min="0" max="30" step="0.1"><span class="ub">% p.a.</span></div></div>
    </div>
    <div class="ps">
      <div class="sl">Sonderzahlungen</div>
      <div id="einmal-c"></div>
      <button class="btn-add" onclick="addEinmal()">+ Einmalzahlung</button>
      <div class="opt-toggle" onclick="toggleLReg()" style="margin-top:12px;border-radius:10px">
        <span class="opt-label">ğŸ”„ RegelmÃ¤ÃŸige Einmalzahlung</span>
        <div class="opt-pill" id="lreg-pill"></div>
      </div>
      <div id="lreg-fields" class="hidden">
        <div style="padding:4px 0 4px">
          <div class="f"><label>Betrag</label>
            <div class="fu"><input type="number" id="l_reg_betrag" value="1000" min="0" step="100" oninput="lRegBetrag=+this.value;berechneLang()"><span class="ub">â‚¬</span></div></div>
          <div class="f"><label>Alle X Jahre</label>
            <div class="fu"><input type="number" id="l_reg_int" value="1" min="1" step="1" oninput="lRegIntervall=+this.value;berechneLang()"><span class="ub">J.</span></div></div>
          <div class="f"><label>Ab Jahr</label>
            <div class="fu"><input type="number" id="l_reg_ab" value="1" min="0" step="1" oninput="lRegAbJahr=+this.value;berechneLang()"><span class="ub">J.</span></div></div>
        </div>
      </div>
    </div>
    <!-- FLV-Kosten: fixe Werte, ausgeblendet -->
    <div class="hidden">
      <input type="number" id="l_fagio" value="7.65">
      <input type="number" id="l_fkosten" value="0.61">
    </div>
    <!-- Depotanbieter collapsible -->
    <div class="ct" onclick="toggleColl(this)" id="ct-l-depot">
      <div class="sl">Depotanbieter</div><span class="ca">â–¼</span>
    </div>
    <div class="cb" id="cb-l-depot">
      <div style="padding:14px 18px 10px">
        <div class="mode-toggle" style="margin-bottom:10px">
          <button class="mode-btn on" id="lpb-fonds" onclick="setLangProdType('fonds')">ğŸ“ˆ Investmentfonds</button>
          <button class="mode-btn" id="lpb-etf" onclick="setLangProdType('etf')">ğŸ“Š ETF</button>
        </div>
        <select id="l_anbieter" onchange="setLangAnbieter()">
          <option value="manuell">Manuell</option>
          <option value="flatex">Flatex AT</option>
          <option value="traderepublic">Trade Republic</option>
          <option value="dadat">Dadat</option>
          <option value="easybank">Easybank</option>
          <option value="bks">BKS Bank</option>
          <option value="erste">Erste Bank / George</option>
          <option value="raiffeisen">Raiffeisen Wien</option>
          <option value="bankaustr">Bank Austria</option>
          <option value="bawag">BAWAG P.S.K.</option>
          <option value="plattform" selected>die Plattform</option>
        </select>
        <div class="ib hidden" id="l_anbieter_info" style="margin-top:10px"></div>
      </div>
    </div>
    <div class="ct" onclick="toggleColl(this)" id="ct-depot">
      <div class="sl">Depot â€” Kosten</div><span class="ca">â–¼</span>
    </div>
    <div class="cb" id="cb-depot">
      <div class="f"><label>Agio Depot</label><div class="fu"><input type="number" id="l_dagio" value="0" step="0.1" min="0"><span class="ub">%</span></div></div>
      <div class="f"><label>DepotgebÃ¼hr p.a.</label><div class="fu"><input type="number" id="l_ddepotgeb" value="0" step="0.01" min="0" oninput="berechneLang()"><span class="ub">% p.a.</span></div></div>
      <div class="f"><label>Sparplan-Order</label><div class="fu"><input type="number" id="l_dsp" value="1.50" step="0.10" min="0"><span class="ub">â‚¬</span></div></div>
      <div class="f"><label>Einzelkauf-Order</label><div class="fu"><input type="number" id="l_dez" value="5.90" step="0.10" min="0"><span class="ub">â‚¬</span></div></div>
      <div class="f"><label>TER p.a.</label><div class="fu"><input type="number" id="l_dter" value="0.30" step="0.01" min="0"><span class="ub">% p.a.</span></div></div>
      <div class="f"><label>KESt</label><div class="fu"><input type="number" id="l_dkest" value="27.5" step="0.1" min="0" max="100"><span class="ub">%</span></div></div>
      <div class="f"><label>Dividendenrendite p.a.</label><div class="fu"><input type="number" id="l_ddiv" value="2" step="0.1" min="0"><span class="ub">% p.a.</span></div></div>
      <div class="f"><label>Anteil AgE</label><div class="fu"><input type="number" id="l_dage" value="100" step="1" min="0" max="100"><span class="ub">%</span></div></div>
      <div class="f"><label>Spread An-/Verkauf</label><div class="fu"><input type="number" id="l_dspread" value="0" min="0" step="0.01" oninput="berechneLang()"><span class="ub">%</span></div></div>
    </div>
    <div class="ps">
      <button class="btn-calc" onclick="berechneLang()">Berechnen</button>
    </div>
  </aside>

  <div class="rp">
    <div class="g2">
      <div class="met hi">
        <span class="mi">âš–ï¸</span>
        <div class="ml">Break-even FLV vs. Depot</div>
        <div class="mv ac" id="l_be_thes">â€”</div>
        <div class="ms" id="l_be_thes_s" style="margin-bottom:10px"></div>
        <div style="height:1px;background:var(--brd);margin:8px 0"></div>
        <div class="ml" style="margin-bottom:5px">vs. AusschÃ¼ttend</div>
        <div class="mv ac" id="l_be_ausch" style="font-size:18px;margin-bottom:4px">â€”</div>
        <div class="ms" id="l_be_ausch_s"></div>
      </div>
      <div class="met">
        <span class="mi">ğŸ“Š</span>
        <div class="ml">FLV-Vorteil am Ende</div>
        <div class="mv" id="l_delta">â€”</div>
        <div class="ms" id="l_delta_s">vs. bestes Depot</div>
      </div>
    </div>
    <div class="g2">
      <div class="met"><div class="ml">FLV (Netto)</div><div class="mv green" id="l_flv">â€”</div><div class="ms">nach Kosten & Steuer</div></div>
      <div class="met"><div class="ml">Depot Thesaurierend</div><div class="mv blue" id="l_thes">â€”</div><div class="ms">nach KESt bei Verkauf</div></div>
    </div>
    <div class="card">
      <div class="ch"><span class="ct-title">Kapitalentwicklung (nach Steuern)</span><div class="legend" id="l_legend"></div></div>
      <div class="chart-box"><canvas id="langChart"></canvas></div>
    </div>
    <div class="card">
      <div class="ch"><span class="ct-title">Jahrestabelle</span></div>
      <div class="tw">
        <table>
          <thead><tr><th>Jahr</th><th>Eingezahlt</th><th style="color:#4ade80">FLV</th><th style="color:#60a5fa">Thesaur.</th><th style="color:#fb923c">AusschÃ¼tt.</th></tr></thead>
          <tbody id="l_tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function goTo(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('view-'+id).classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
  if(id==='dash') syncDash();
}

function syncDash(){
  const kZ=document.getElementById('k_ziel')?.textContent;
  const kD=document.getElementById('k_dauer')?.textContent;
  if(kZ&&kZ!=='â€”'){
    document.getElementById('dash-k').textContent=kZ;
    document.getElementById('dk-ziel').textContent=kZ;
    document.getElementById('dk-dauer').textContent=kD||'â€”';
  }
  // Mittel
  if(lastMFonds>0){
    const v=eur(lastMFonds);
    const vz=(lastMZins>=0?'+':'')+eur(lastMZins);
    document.getElementById('dash-m').textContent=v;
    document.getElementById('dash-m').style.color='var(--tp)';
    document.getElementById('dm-fonds').textContent=v;
    document.getElementById('dm-delta').textContent=vz;
  }
  if(lastLFlv>0){
    document.getElementById('dash-l').textContent=eur(lastLFlv);
    document.getElementById('dash-l').style.color='var(--tp)';
    document.getElementById('dl-flv').textContent=eur(lastLFlv);
    document.getElementById('dl-depot').textContent=(lastLDelta>=0?'+':'')+eur(lastLDelta);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLLAPSIBLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleColl(t){
  t.classList.toggle('open');
  document.getElementById(t.id.replace('ct-','cb-')).classList.toggle('open');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEPOTANBIETER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DEPOTANBIETER={
  flatex:       {name:'Flatex AT',
    etf:  {agio:0,  sp:0,    ez:5.90,  dg:0,    spread:0.05},
    fonds:{agio:0,  sp:0,    ez:5.90,  dg:0,    spread:0.05}},
  traderepublic:{name:'Trade Republic',
    etf:  {agio:0,  sp:0,    ez:1.00,  dg:0,    spread:0.05},
    fonds:{agio:0,  sp:0,    ez:1.00,  dg:0,    spread:0.05}},
  dadat:        {name:'Dadat',
    etf:  {agio:0,  sp:0,    ez:3.99,  dg:0,    spread:0.05},
    fonds:{agio:0,  sp:0,    ez:3.99,  dg:0,    spread:0.05}},
  easybank:     {name:'Easybank',
    etf:  {agio:0,  sp:1.50, ez:9.90,  dg:0,    spread:0   },
    fonds:{agio:2.5,sp:1.50, ez:9.90,  dg:0,    spread:0   }},
  bks:          {name:'BKS Bank (Klassik)',
    etf:  {agio:1.6,sp:0,    ez:36.90, dg:0.28, spread:0   },
    fonds:{agio:3.0,sp:0,    ez:15.00, dg:0.28, spread:0   }},
  erste:        {name:'Erste Bank / George',
    etf:  {agio:0,  sp:0,    ez:9.95,  dg:0,    spread:0   },
    fonds:{agio:4.0,sp:0,    ez:9.95,  dg:0,    spread:0   }},
  raiffeisen:   {name:'Raiffeisen Wien',
    etf:  {agio:0,  sp:3.95, ez:12.95, dg:0,    spread:0   },
    fonds:{agio:5.0,sp:3.95, ez:12.95, dg:0,    spread:0   }},
  bankaustr:    {name:'Bank Austria',
    etf:  {agio:0,  sp:5.00, ez:12.95, dg:0,    spread:0   },
    fonds:{agio:5.0,sp:5.00, ez:12.95, dg:0,    spread:0   }},
  bawag:        {name:'BAWAG P.S.K.',
    etf:  {agio:0,  sp:1.95, ez:10.95, dg:0,    spread:0   },
    fonds:{agio:3.5,sp:1.95, ez:10.95, dg:0,    spread:0   }},
  plattform:    {name:'die Plattform',
    etf:  {agio:0,  sp:0.95, ez:3.50,  dg:0.3,  spread:0   },
    fonds:{agio:3.5,sp:0.45, ez:6.00,  dg:0.2,  spread:0   }},
  manuell:      {name:'Manuell',etf:null,fonds:null}
};

const ANBIETER_NOTES={
  bks:'âš ï¸ <b>Klassik-Depot:</b> ZusÃ¤tzlich â‚¬2,80/Monat ServicegebÃ¼hr (â‚¬33,60 p.a.) â€” nicht modelliert. ETF-Sparplan-GebÃ¼hr (1,60%) als Agio dargestellt.',
  plattform:'â„¹ï¸ <b>die Plattform:</b> ZusÃ¤tzlich +0,15% pro Order-Transaktion sowie â‚¬5,30/Quartal VerrechnungskontogebÃ¼hr â€” nicht modelliert.'
};

function showAnbieterNote(infoId,key){
  const el=document.getElementById(infoId);
  if(!el)return;
  const note=ANBIETER_NOTES[key];
  if(note){el.innerHTML=note;el.classList.remove('hidden');}
  else el.classList.add('hidden');
}

let lProdType='fonds';
let mProdType='fonds';

function setLangProdType(t){
  lProdType=t;
  document.getElementById('lpb-etf').classList.toggle('on',t==='etf');
  document.getElementById('lpb-fonds').classList.toggle('on',t==='fonds');
  if(document.getElementById('l_anbieter').value!=='manuell')setLangAnbieter();
  else berechneLang();
}
function setMittelProdType(t){
  mProdType=t;
  document.getElementById('mpb-etf').classList.toggle('on',t==='etf');
  document.getElementById('mpb-fonds').classList.toggle('on',t==='fonds');
  if(document.getElementById('m_anbieter').value!=='manuell')setMittelAnbieter();
  else berechneMittel();
}
function setLangAnbieter(){
  const key=document.getElementById('l_anbieter').value;
  showAnbieterNote('l_anbieter_info',key);
  const p=DEPOTANBIETER[key];
  if(!p)return;
  const cfg=p[lProdType];
  if(!cfg)return;
  document.getElementById('l_dagio').value=cfg.agio;
  document.getElementById('l_dsp').value=cfg.sp;
  document.getElementById('l_dez').value=cfg.ez;
  document.getElementById('l_ddepotgeb').value=cfg.dg;
  document.getElementById('l_dspread').value=cfg.spread||0;
  berechneLang();
}
function setMittelAnbieter(){
  const key=document.getElementById('m_anbieter').value;
  showAnbieterNote('m_anbieter_info',key);
  const p=DEPOTANBIETER[key];
  if(!p)return;
  const cfg=p[mProdType];
  if(!cfg)return;
  document.getElementById('m_agio').value=cfg.agio;
  document.getElementById('m_order').value=cfg.sp;
  document.getElementById('m_depotgeb').value=cfg.dg;
  document.getElementById('m_spread').value=cfg.spread||0;
  berechneMittel();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MITTELFRISTIG MODE + TAGESGELD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let mMode='frei';
let mRegAn=false,mRegBetrag=1000,mRegIntervall=1,mRegAbJahr=1;
let tagesAn=false;
let lastMFonds=0,lastMZins=0;
let lastLFlv=0,lastLDelta=0;

function setMode(m){
  mMode=m;
  document.getElementById('mb-ziel').classList.toggle('on',m==='ziel');
  document.getElementById('mb-frei').classList.toggle('on',m==='frei');
  document.getElementById('ziel-fields').classList.toggle('hidden',m!=='ziel');
  document.getElementById('frei-fields').classList.toggle('hidden',m!=='frei');
  berechneMittel();
}

function toggleTages(){
  tagesAn=!tagesAn;
  document.getElementById('tages-pill').classList.toggle('on',tagesAn);
  document.getElementById('tages-fields').classList.toggle('hidden',!tagesAn);
  berechneMittel();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMATTERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function eur(v){return new Intl.NumberFormat('de-AT',{style:'currency',currency:'EUR',minimumFractionDigits:2}).format(v);}
function eurS(v){
  if(v>=1e6) return (v/1e6).toFixed(2)+' Mâ‚¬';
  if(v>=1e3) return (v/1e3).toFixed(0)+' Kâ‚¬';
  return v.toFixed(0)+' â‚¬';
}
function tc(){
  const d=window.matchMedia('(prefers-color-scheme:dark)').matches;
  return{grid:d?'rgba(255,255,255,.04)':'rgba(0,0,0,.05)',ticks:d?'#555860':'#AAAAAA',
    bg:d?'#16171B':'#F7F2EA',bdr:d?'#282930':'#DEDAD3',tt:d?'#F0EDE8':'#1A1A1A',ts:'#969696'};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KURZFRISTIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let kChart=null;
const KHINT={
  tagesgeld:'<b>Tagesgeld</b>: tÃ¤glich verfÃ¼gbar, 2â€“4 % p.a. â€” ideal fÃ¼r den Notgroschen.',
  festgeld:'<b>Festgeld</b>: hÃ¶here Zinsen, aber Kapital gebunden. Nur fÃ¼r BetrÃ¤ge Ã¼ber dem Notgroschen.',
  sparkonto:'<b>Sparkonto</b>: geringe Zinsen, flexibel verfÃ¼gbar.',
  girokonto:'<b>Girokonto</b>: keine Zinsen â€” Tagesgeld wÃ¤re deutlich besser.'
};
function updateKontoHint(){document.getElementById('k_hint').innerHTML=KHINT[document.getElementById('k_typ').value];}

function berechneKurz(){
  const eink=+document.getElementById('k_eink').value||0;
  const vorh=+document.getElementById('k_vorh').value||0;
  const rate=+document.getElementById('k_rate').value||0;
  const mo=+document.getElementById('k_mo').value||3;
  const zpa=(+document.getElementById('k_zins').value||0)/100;
  const ziel=eink*mo;

  let k=vorh,tz=0,zm=null;const rows=[];
  for(let m=1;m<=120;m++){
    const z=k*(zpa/12);tz+=z;k+=z+rate;
    rows.push({m,rate,z,k:Math.min(k,ziel>0?ziel*1.5:k),tz});
    if(k>=ziel&&!zm)zm=m;
    if(ziel>0&&k>=ziel*1.5)break;
    if(ziel===0)break;
  }

  document.getElementById('k_ziel').textContent=eur(ziel);
  document.getElementById('k_zsub').textContent=`${mo}Ã— Monatsnetto (${eur(eink)})`;

  if(!ziel){set('k_dauer','â€”');set('k_dsub','Einkommen eingeben');}
  else if(!rate&&vorh<ziel){set('k_dauer','âˆ');set('k_dsub','Keine Sparrate eingetragen');}
  else if(zm){
    const j=Math.floor(zm/12),r=zm%12;
    set('k_dauer',(j>0?`${j} J. ${r>0?r+' Mo.':''}`:zm+' Monate').trim());
    set('k_dsub',`Erreicht in Monat ${zm}`);
  }else{set('k_dauer','> 10 J.');set('k_dsub','Sparrate erhÃ¶hen empfohlen');}

  document.getElementById('k_zins_val').textContent=eur(zm?rows[zm-1]?.tz||0:rows.at(-1)?.tz||0);
  const pct=ziel>0?Math.min(100,(vorh/ziel)*100):0;
  document.getElementById('k_pb').style.width=pct+'%';
  document.getElementById('k_pp').textContent=pct.toFixed(1)+' % erreicht';
  document.getElementById('k_ps').textContent=`Vorhanden: ${eur(vorh)}`;
  document.getElementById('k_pe').textContent=`Ziel: ${eur(ziel)}`;

  if(kChart)kChart.destroy();
  const t=tc();
  kChart=new Chart(document.getElementById('kurzChart').getContext('2d'),{
    type:'line',
    data:{labels:rows.map(r=>'M'+r.m),datasets:[
      {label:'Kapital',data:rows.map(r=>r.k),borderColor:'#38D9A3',backgroundColor:'rgba(56,217,163,.07)',borderWidth:2.5,tension:.4,pointRadius:0,fill:true},
      {label:'Ziel',data:rows.map(()=>ziel),borderColor:'#f87171',borderDash:[6,3],borderWidth:1.5,pointRadius:0,fill:false}
    ]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{backgroundColor:t.bg,borderColor:t.bdr,borderWidth:1,padding:10,titleColor:t.tt,bodyColor:t.ts,callbacks:{label:c=>` ${c.dataset.label}: ${eur(c.parsed.y)}`}}},
      scales:{
        x:{grid:{color:t.grid,drawTicks:false},ticks:{color:t.ticks,font:{size:10},maxTicksLimit:12},border:{color:'transparent'}},
        y:{grid:{color:t.grid,drawTicks:false},ticks:{color:t.ticks,font:{size:10},callback:v=>eurS(v)},border:{color:'transparent'}}
      }}
  });

  const tb=document.getElementById('k_tbody');tb.innerHTML='';
  const show=Math.min(rows.length,(zm||36)+2);
  for(let i=0;i<show;i++){
    const r=rows[i],fl=Math.max(0,ziel-r.k),tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.m}</td><td>${eur(r.rate)}</td><td style="color:#38D9A3">${eur(r.z)}</td><td style="color:${r.k>=ziel?'#4ade80':'var(--ts)'}">${eur(r.k)}</td><td style="color:${fl===0?'#4ade80':'var(--ts)'}">${fl===0?'âœ“ Erreicht':eur(fl)}</td>`;
    tb.appendChild(tr);
  }
}
function set(id,v){document.getElementById(id).textContent=v;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MITTELFRISTIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let mChart=null;
let mVis={fonds:true,tages:true,einz:true};

function berechneMittel(){
  const isZ=mMode==='ziel';
  const jahre=isZ?(+document.getElementById('m_jahre').value||5):(+document.getElementById('mf_jahre').value||5);
  const start=isZ?(+document.getElementById('m_start').value||0):(+document.getElementById('mf_start').value||0);
  const rate =isZ?(+document.getElementById('m_rate').value||0) :(+document.getElementById('mf_rate').value||0);
  const ziel =isZ?(+document.getElementById('m_ziel').value||0) :null;
  const name =isZ?(document.getElementById('m_name').value||'Sparziel'):'Freies Sparen';
  const rendite=(+document.getElementById('m_rendite').value||0)/100;
  const ter   =(+document.getElementById('m_ter').value||0)/100;
  const order =+document.getElementById('m_order').value||0;
  const kest  =(+document.getElementById('m_kest').value||0)/100;
  const agio  =(+(document.getElementById('m_agio')?.value||0))/100;
  const depotgeb=(+(document.getElementById('m_depotgeb')?.value||0))/100;
  const tzins =tagesAn?(+document.getElementById('m_tzins').value||0)/100:0;
  const tkest =tagesAn?(+document.getElementById('m_tkest').value||0)/100:0;
  const div   =(+(document.getElementById('m_ddiv')?.value||0))/100;
  const age   =(+(document.getElementById('m_dage')?.value||100))/100;
  const spread=(+(document.getElementById('m_spread')?.value||0))/100;
  const qf=Math.pow(1+rendite-ter-depotgeb,1/12);

  function calcF(r,j){
    let k=start,b=start;
    for(let m=1;m<=j*12;m++){
      const ns=Math.max(0,r*(1-agio)*(1-spread)-order);k+=ns;b+=r;k*=qf;
      if(m%12===0){const te=k*div;const st=te*age*kest;k-=st;b+=te*age;}
    }
    const ks=k*(1-spread);return ks-Math.max(0,ks-b)*kest;
  }

  let needed=null;
  if(isZ&&ziel>0){
    if(calcF(0,jahre)>=ziel){needed=0;}
    else{let lo=0,hi=ziel/12;for(let i=0;i<80;i++){const mid=(lo+hi)/2;if(calcF(mid,jahre)<ziel)lo=mid;else hi=mid;}needed=(lo+hi)/2;}
  }

  // Update hint
  if(isZ&&needed!==null){
    const d=rate-needed,h=document.getElementById('m_hint');
    if(h){
      if(Math.abs(d)<1)h.innerHTML='<b>Perfekt!</b> Deine Sparrate trifft das Ziel exakt.';
      else if(d>0)h.innerHTML=`<b>+${eur(d)}/Mo.</b> Ã¼ber der benÃ¶tigten Rate â€” du Ã¼bertriffst das Ziel.`;
      else h.innerHTML=`BenÃ¶tigte Rate: <b>${eur(needed)}/Mo.</b> â€” noch <b>${eur(Math.abs(d))}/Mo.</b> zu wenig.`;
    }
  }

  const allMEinmal=mRegAn?genRegEinmal(
    +(document.getElementById('m_reg_betrag')?.value||0),
    +(document.getElementById('m_reg_int')?.value||1),
    +(document.getElementById('m_reg_ab')?.value||1),
    jahre):[];
  const rows=[];let kf=start,bf=start,kt=start,cumEz=0;
  // Jahr-0-Einmalzahlungen
  for(const ez of allMEinmal.filter(e=>e.j<=0)){
    const ns=Math.max(0,ez.b*(1-agio)*(1-spread)-order);kf+=ns;bf+=ez.b;kt+=ez.b;cumEz+=ez.b;
  }
  for(let j=1;j<=jahre;j++){
    // Einmalzahlungen fÃ¼r dieses Jahr
    const ezJ=allMEinmal.filter(e=>e.j===j).reduce((s,e)=>s+e.b,0);
    if(ezJ>0){const ns=Math.max(0,ezJ*(1-agio)*(1-spread)-order);kf+=ns;bf+=ezJ;kt+=ezJ;cumEz+=ezJ;}
    for(let m=1;m<=12;m++){
      const ns=Math.max(0,rate*(1-agio)*(1-spread)-order);kf+=ns;bf+=rate;kf*=qf;
      if(tagesAn){const z=kt*(tzins/12);kt+=rate+z-z*tkest;}
      else kt+=rate;
    }
    // JÃ¤hrliche AgE-Besteuerung (AusschÃ¼ttungsgleicher Ertrag)
    const te=kf*div;const st=te*age*kest;kf-=st;bf+=te*age;
    // Verkauf-Spread auf hypothetischen Jahresendwert
    const kfs=kf*(1-spread);
    rows.push({j,e:start+rate*j*12+cumEz,f:kfs-Math.max(0,kfs-bf)*kest,t:kt});
  }
  const last=rows.at(-1);
  lastMFonds=last.f;
  lastMZins=last.f-last.e;

  // Build result HTML
  const panel=document.getElementById('m_results');
  panel.innerHTML='';

  // Top metrics
  const g=document.createElement('div');
  g.className='g3';

  if(isZ){
    g.innerHTML=`
      <div class="met hi"><span class="mi">ğŸ¯</span><div class="ml">Zielbetrag</div><div class="mv ac">${eur(ziel)}</div><div class="ms">${name}</div></div>
      <div class="met"><span class="mi">ğŸ“ˆ</span><div class="ml">Fonds-Ergebnis</div><div class="mv blue">${eur(last.f)}</div><div class="ms">${last.f>=ziel?'âœ“ Ziel erreicht!':'LÃ¼cke: '+eur(ziel-last.f)}</div></div>
      <div class="met"><span class="mi">ğŸ’¡</span><div class="ml">BenÃ¶tigte Sparrate</div><div class="mv">${needed!==null?eur(needed)+'/Mo.':'â€”'}</div><div class="ms">um Ziel exakt zu erreichen</div></div>`;
  }else{
    g.innerHTML=`
      <div class="met hi"><span class="mi">ğŸ“ˆ</span><div class="ml">Fonds-Ergebnis</div><div class="mv ac">${eur(last.f)}</div><div class="ms">nach ${jahre} Jahren</div></div>
      <div class="met"><span class="mi">ğŸ’°</span><div class="ml">Eingezahlt</div><div class="mv">${eur(last.e)}</div><div class="ms">Gesamte Einzahlungen</div></div>
      <div class="met"><span class="mi">âš¡</span><div class="ml">Netto-Zuwachs</div><div class="mv pos">+${eur(last.f-last.e)}</div><div class="ms">Rendite nach KESt</div></div>`;
  }
  panel.appendChild(g);

  // Tagesgeld row â€” only if toggled on
  if(tagesAn){
    const gt=document.createElement('div');
    gt.className='g2';
    const delta=last.f-last.t;
    gt.innerHTML=`
      <div class="met"><span class="mi">ğŸ¦</span><div class="ml">Tagesgeld-Ergebnis</div><div class="mv green">${eur(last.t)}</div><div class="ms">nach KESt</div></div>
      <div class="met"><span class="mi">âš¡</span><div class="ml">Vorteil Fonds vs. Tagesgeld</div><div class="mv ${delta>=0?'pos':'neg'}">${(delta>=0?'+':'')+eur(delta)}</div><div class="ms">${delta>=0?'Fonds liegt vorne':'Tagesgeld liegt vorne'}</div></div>`;
    panel.appendChild(gt);
  }

  // Chart
  const cc=document.createElement('div');cc.className='card';
  cc.innerHTML=`<div class="ch"><span class="ct-title">Kapitalentwicklung</span><div class="legend" id="m_leg"></div></div><div class="chart-box"><canvas id="mChart"></canvas></div>`;
  panel.appendChild(cc);

  // Table
  const tc2=document.createElement('div');tc2.className='card';
  const extraH=isZ?'<th>ZiellÃ¼cke</th>':'<th>Zuwachs</th>';
  tc2.innerHTML=`<div class="ch"><span class="ct-title">JahresÃ¼bersicht</span></div><div class="tw"><table><thead><tr><th>Jahr</th><th>Eingezahlt</th><th style="color:#60a5fa">Fonds</th>${tagesAn?'<th style="color:#4ade80">Tagesgeld</th>':''}${extraH}</tr></thead><tbody id="m_tbody"></tbody></table></div>`;
  panel.appendChild(tc2);

  // Render chart
  if(mChart)mChart.destroy();
  const t=tc();
  const ds=[
    {label:'Fonds',data:rows.map(r=>r.f),borderColor:'#60a5fa',backgroundColor:'rgba(96,165,250,.06)',borderWidth:2.5,tension:.4,pointRadius:0,fill:false,hidden:!mVis.fonds}
  ];
  if(tagesAn) ds.push({label:'Tagesgeld',data:rows.map(r=>r.t),borderColor:'#4ade80',backgroundColor:'rgba(74,222,128,.06)',borderWidth:2.5,tension:.4,pointRadius:0,fill:false,hidden:!mVis.tages});
  ds.push({label:'Eingezahlt',data:rows.map(r=>r.e),borderColor:'#555860',borderDash:[5,3],borderWidth:1.5,tension:0,pointRadius:0,fill:false,hidden:!mVis.einz});
  if(isZ&&ziel>0) ds.push({label:'Ziel: '+name,data:rows.map(()=>ziel),borderColor:'#f87171',borderDash:[6,3],borderWidth:1.5,pointRadius:0,fill:false});

  mChart=new Chart(document.getElementById('mChart').getContext('2d'),{
    type:'line',data:{labels:rows.map(r=>'J.'+r.j),datasets:ds},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{backgroundColor:t.bg,borderColor:t.bdr,borderWidth:1,padding:10,titleColor:t.tt,bodyColor:t.ts,callbacks:{label:c=>` ${c.dataset.label}: ${eur(c.parsed.y)}`}}},
      scales:{
        x:{grid:{color:t.grid,drawTicks:false},ticks:{color:t.ticks,font:{size:10}},border:{color:'transparent'}},
        y:{grid:{color:t.grid,drawTicks:false},ticks:{color:t.ticks,font:{size:10},callback:v=>eurS(v)},border:{color:'transparent'}}
      }}
  });

  // Legend
  const lg=document.getElementById('m_leg');
  if(lg){
    lg.innerHTML='';
    const items=[['fonds','#60a5fa','Fonds',0]];
    if(tagesAn)items.push(['tages','#4ade80','Tagesgeld',1]);
    items.push(['einz','#555860','Eingezahlt',tagesAn?2:1]);
    items.forEach(([k,c,l,di])=>{
      const item=document.createElement('div');
      item.className='li '+(mVis[k]?'on':'off');
      item.style.color=mVis[k]?c:'var(--tm)';
      item.innerHTML=`<span class="ld" style="background:${c}"></span>${l}`;
      item.onclick=()=>{mVis[k]=!mVis[k];mChart.data.datasets[di].hidden=!mVis[k];mChart.update();item.classList.toggle('on',mVis[k]);item.classList.toggle('off',!mVis[k]);item.style.color=mVis[k]?c:'var(--tm)';};
      lg.appendChild(item);
    });
  }

  // Table rows
  const tb2=document.getElementById('m_tbody');
  if(tb2){
    tb2.innerHTML='';
    rows.forEach(r=>{
      const extra=isZ?`<td style="color:${r.f>=(ziel||0)?'#4ade80':'var(--ts)'}">${r.f>=(ziel||0)?'âœ“':eur((ziel||0)-r.f)}</td>`:`<td style="color:#4ade80">+${eur(r.f-r.e)}</td>`;
      const tagesCell=tagesAn?`<td style="color:#4ade80">${eur(r.t)}</td>`:'';
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.j}</td><td>${eur(r.e)}</td><td style="color:#60a5fa">${eur(r.f)}</td>${tagesCell}${extra}`;
      tb2.appendChild(tr);
    });
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANGFRISTIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let lRegAn=false,lRegBetrag=1000,lRegIntervall=1,lRegAbJahr=1;
let lChart=null;
let lVis={flv:true,thes:true,ausch:true,einz:true};
let einmal=[{j:0,b:2000},{j:5,b:5000},{j:7,b:5000}];

function genRegEinmal(betrag,intervall,abJahr,laufzeit){
  const r=[];if(betrag<=0||intervall<=0)return r;
  for(let j=abJahr;j<=laufzeit;j+=intervall)r.push({j,b:betrag});
  return r;
}
function toggleMReg(){
  mRegAn=!mRegAn;
  document.getElementById('mreg-pill').classList.toggle('on',mRegAn);
  document.getElementById('mreg-fields').classList.toggle('hidden',!mRegAn);
  berechneMittel();
}
function toggleLReg(){
  lRegAn=!lRegAn;
  document.getElementById('lreg-pill').classList.toggle('on',lRegAn);
  document.getElementById('lreg-fields').classList.toggle('hidden',!lRegAn);
  berechneLang();
}
function renderEinmal(){
  const c=document.getElementById('einmal-c');c.innerHTML='';
  einmal.forEach((e,i)=>{
    const row=document.createElement('div');row.className='er';
    row.innerHTML=`
      <div>${i===0?'<label>Jahr</label>':'<label style="visibility:hidden">J</label>'}
        <div class="fu"><input type="number" value="${e.j}" min="0" onchange="einmal[${i}].j=+this.value" style="border-radius:8px 0 0 8px;border-right:none"><span class="ub">J.</span></div></div>
      <div>${i===0?'<label>Betrag</label>':'<label style="visibility:hidden">B</label>'}
        <div class="fu"><input type="number" value="${e.b}" min="0" step="100" onchange="einmal[${i}].b=+this.value" style="border-radius:8px 0 0 8px;border-right:none"><span class="ub">â‚¬</span></div></div>
      <div style="display:flex;align-items:flex-end"><button class="btn-rm" onclick="removeEinmal(${i})">Ã—</button></div>`;
    c.appendChild(row);
  });
}
function addEinmal(){einmal.push({j:0,b:0});renderEinmal();}
function removeEinmal(i){einmal.splice(i,1);renderEinmal();}
renderEinmal();

const LC={flv:'#4ade80',thes:'#60a5fa',ausch:'#fb923c',einz:'#555860'};
const LL={flv:'FLV Netto',thes:'Depot Thesaurierend',ausch:'Depot AusschÃ¼ttend',einz:'Eingezahlt'};

function buildLangLeg(){
  const lg=document.getElementById('l_legend');lg.innerHTML='';
  const keys=Object.keys(LC);
  keys.forEach((k,di)=>{
    const item=document.createElement('div');
    item.className='li '+(lVis[k]?'on':'off');
    item.style.color=lVis[k]?LC[k]:'var(--tm)';
    item.innerHTML=`<span class="ld" style="background:${LC[k]}"></span>${LL[k]}`;
    item.onclick=()=>{lVis[k]=!lVis[k];if(lChart){lChart.data.datasets[di].hidden=!lVis[k];lChart.update();}buildLangLeg();};
    lg.appendChild(item);
  });
}

function berechneLang(){
  const mb=+document.getElementById('l_mb').value;
  const lj=+document.getElementById('l_lj').value;
  const rpa=+document.getElementById('l_rpa').value/100;
  const lRegArr=lRegAn?genRegEinmal(
    +(document.getElementById('l_reg_betrag')?.value||0),
    +(document.getElementById('l_reg_int')?.value||1),
    +(document.getElementById('l_reg_ab')?.value||1),
    lj):[];
  const ein=[...einmal,...lRegArr].map(e=>({j:+e.j,b:+e.b||0}));
  const flv={ai:+document.getElementById('l_fagio').value/100,lk:+document.getElementById('l_fkosten').value/100};
  const dep={ag:+document.getElementById('l_dagio').value/100,sp:+document.getElementById('l_dsp').value,ez:+document.getElementById('l_dez').value,ter:+document.getElementById('l_dter').value/100,ke:+document.getElementById('l_dkest').value/100,dv:+document.getElementById('l_ddiv').value/100,ae:+document.getElementById('l_dage').value/100,dg:+(document.getElementById('l_ddepotgeb')?.value||0)/100,spread:+(document.getElementById('l_dspread')?.value||0)/100};

  const data=calcFLV(mb,lj,rpa,ein,flv,dep);
  const last=data.at(-1);
  lastLFlv=last.FN;
  lastLDelta=last.FN-Math.max(last.TN,last.AN);

  if(lChart)lChart.destroy();
  const t=tc();
  lChart=new Chart(document.getElementById('langChart').getContext('2d'),{
    type:'line',
    data:{labels:data.map(r=>r.J),datasets:[
      {label:LL.flv, data:data.map(r=>r.FN),borderColor:LC.flv, backgroundColor:'rgba(74,222,128,.05)',borderWidth:2.5,tension:.4,pointRadius:0,fill:false,hidden:!lVis.flv},
      {label:LL.thes,data:data.map(r=>r.TN),borderColor:LC.thes,backgroundColor:'rgba(96,165,250,.05)',borderWidth:2.5,tension:.4,pointRadius:0,fill:false,hidden:!lVis.thes},
      {label:LL.ausch,data:data.map(r=>r.AN),borderColor:LC.ausch,borderDash:[5,3],borderWidth:2,tension:.4,pointRadius:0,fill:false,hidden:!lVis.ausch},
      {label:LL.einz,data:data.map(r=>r.E), borderColor:LC.einz, borderDash:[6,4],borderWidth:1.5,tension:0,pointRadius:0,fill:false,hidden:!lVis.einz}
    ]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{backgroundColor:t.bg,borderColor:t.bdr,borderWidth:1,padding:12,titleColor:t.tt,bodyColor:t.ts,callbacks:{label:c=>` ${c.dataset.label}: ${eur(c.parsed.y)}`}}},
      scales:{
        x:{grid:{color:t.grid,drawTicks:false},ticks:{color:t.ticks,font:{size:11},maxTicksLimit:10},border:{color:'transparent'}},
        y:{grid:{color:t.grid,drawTicks:false},ticks:{color:t.ticks,font:{size:11},callback:v=>eurS(v)},border:{color:'transparent'}}
      }}
  });
  buildLangLeg();

  document.getElementById('l_flv').textContent =eur(last.FN);
  document.getElementById('l_thes').textContent=eur(last.TN);

  let beT=null,beA=null;
  for(const d of data){if(!beT&&d.FN>=d.TN)beT=d.J;if(!beA&&d.FN>=d.AN)beA=d.J;}
  set('l_be_thes',beT?'Jahr '+beT:'Nie');
  set('l_be_thes_s',beT?`FLV Ã¼berholt Thesaurierend ab Jahr ${beT}`:'FLV Ã¼berholt Depot in dieser Laufzeit nicht');
  set('l_be_ausch',beA?'Jahr '+beA:'Nie');
  set('l_be_ausch_s',beA?`FLV Ã¼berholt AusschÃ¼ttend ab Jahr ${beA}`:'FLV Ã¼berholt Depot in dieser Laufzeit nicht');

  const bd=Math.max(last.TN,last.AN),bn=last.TN>=last.AN?'Thesaurierend':'AusschÃ¼ttend',dl=last.FN-bd;
  document.getElementById('l_delta').textContent=(dl>=0?'+':'')+eur(dl);
  document.getElementById('l_delta').className='mv '+(dl>=0?'pos':'neg');
  set('l_delta_s',dl>=0?`FLV schlÃ¤gt ${bn} um ${eur(dl)}`:`${bn} schlÃ¤gt FLV um ${eur(Math.abs(dl))}`);

  const tb=document.getElementById('l_tbody');tb.innerHTML='';
  data.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.J}</td><td>${eur(r.E)}</td><td style="color:#4ade80">${eur(r.FN)}</td><td style="color:#60a5fa">${eur(r.TN)}</td><td style="color:#fb923c">${eur(r.AN)}</td>`;tb.appendChild(tr);});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLV MATH â€” 1:1 Python
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function calcFLV(mb,lj,rpa,ein,flv,dep){
  const ref=0.06,qr=Math.pow(1+ref,1/12);
  function rwr(m,n){return Math.abs(ref)<1e-8?m*n:m*((Math.pow(qr,n)-1)/(qr-1));}
  const b1={0:0,1:618.06,2:1270.27,3:1961.42,4:2693.89,5:3470.10,10:11062.82,15:21209.92,20:34766.96,25:52875.92,30:77060,35:109352.45,40:152464.60};
  const b5={0:0,1:3204.64,2:6597.50,3:10192.99,4:14003.30,5:18041.10,10:56149.33,15:108933.69,20:178401.14,25:271203.42,30:395157.38,35:560699.45};
  const qf=Math.pow(1+rpa,1/12),qd=Math.pow(1+rpa-dep.ter-(dep.dg||0),1/12);
  function rwf(m,n){return Math.abs(rpa)<1e-8?m*n:m*((Math.pow(qf,n)-1)/(qf-1));}
  const res=[];let kum=0,fm=0,kt=0,bt=0,ka=0,ba=0;
  const sp=dep.spread||0;
  for(const a of ein)if(a.j<=0){kum+=a.b;bt+=a.b;ba+=a.b;const n=Math.max(0,a.b*(1-dep.ag)*(1-sp)-dep.ez);kt+=n;ka+=n;}
  for(let j=1;j<=lj;j++){
    let bs,be,am;
    if(j<=5){bs=j-1;be=j;am=12;}else{bs=Math.floor((j-1)/5)*5;be=bs+5;am=60;}
    function mr(ks,ke){return(ke-ks*Math.pow(qr,am))/rwr(1,am);}
    let m1,m5;
    if(b1[be]!==undefined&&b5[be]!==undefined){m1=mr(b1[bs],b1[be]);m5=mr(b5[bs],b5[be]);}
    else{m1=mr(b1[35],b1[40]);m5=mr(b5[30],b5[35]);}
    const ma=m1+(m5-m1)*((mb-100)/400);
    fm=fm*Math.pow(qf,12)+rwf(ma,12);
    let fe=0;
    for(const a of ein){
      if(a.j===j){kum+=a.b;bt+=a.b;ba+=a.b;const n=Math.max(0,a.b*(1-dep.ag)*(1-sp)-dep.ez);kt+=n;ka+=n;}
      if(j>=a.j){const jsa=a.j>0?(j-a.j+1):j;fe+=a.b*(1-flv.ai)*Math.pow(1-flv.lk,jsa)*Math.pow(1+rpa,jsa);}
    }
    for(let m=1;m<=12;m++){bt+=mb;ba+=mb;const ns=Math.max(0,mb*(1-dep.ag)*(1-sp)-dep.sp);kt+=ns;ka+=ns;kt*=qd;ka*=qd;}
    const te=kt*dep.dv,st=te*dep.ae*dep.ke;kt-=st;bt+=te*dep.ae;
    const da=ka*dep.dv,sa=da*dep.ke;ka-=sa;ba+=da-sa;
    const kt_s=kt*(1-sp),ka_s=ka*(1-sp);
    const FN=fm+fe,TN=kt_s-Math.max(0,kt_s-bt)*dep.ke,AN=ka_s-Math.max(0,ka_s-ba)*dep.ke;
    res.push({J:j,E:mb*(j*12)+kum,FN,TN,AN});
  }
  return res;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('DOMContentLoaded',()=>{
  berechneKurz();
  setMittelAnbieter();
  setLangAnbieter();
  buildLangLeg();
  syncDash();
});
</script>
</body>
</html>