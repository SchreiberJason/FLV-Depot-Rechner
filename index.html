<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FLV vs. Depot Vergleichsrechner | Jason Schreiber</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Inter+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0a;
    --surface: #111111;
    --surface2: #181818;
    --border: #242424;
    --border-light: #2e2e2e;
    --text: #f0ede8;
    --text-muted: #7a7570;
    --text-light: #b0aa9f;
    --accent: #38D9A3;
    --accent-dim: rgba(56,217,163,0.10);
    --green: #4ade80;
    --blue: #60a5fa;
    --orange: #fb923c;
    --gray: #6b7280;
    --radius: 12px;
    --radius-sm: 8px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter Display', 'Inter', sans-serif;
    font-size: 15px;
    line-height: 1.6;
    min-height: 100vh;
  }

  /* HEADER - removed */

  /* HERO */
  .hero {
    padding: 80px 40px 60px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .hero-label {
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 20px;
  }

  .hero h1 {
    font-family: 'Inter Display', 'Inter', sans-serif;
    font-weight: 700;
    font-size: clamp(36px, 5vw, 58px);
    line-height: 1.1;
    letter-spacing: -0.02em;
    color: var(--text);
    max-width: 700px;
    margin-bottom: 18px;
  }

  .hero h1 em {
    font-style: italic;
    color: var(--accent);
  }

  .hero p {
    color: var(--text-light);
    font-size: 16px;
    max-width: 560px;
    line-height: 1.7;
  }

  /* MAIN LAYOUT */
  .main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 40px 80px;
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 32px;
    align-items: start;
  }

  /* SIDEBAR / PARAMS */
  .params-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    position: sticky;
    top: 24px;
  }

  /* COLLAPSIBLE */
  .collapsible-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    user-select: none;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }

  .collapsible-trigger:hover { background: rgba(255,255,255,0.02); }

  .collapsible-trigger .section-label { margin-bottom: 0; }

  .collapsible-arrow {
    color: var(--text-muted);
    font-size: 12px;
    transition: transform 0.25s ease;
    flex-shrink: 0;
  }

  .collapsible-trigger.open .collapsible-arrow { transform: rotate(180deg); }

  .collapsible-body {
    display: none;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
  }

  .collapsible-body.open { display: block; }

  .params-section {
    padding: 24px;
    border-bottom: 1px solid var(--border);
  }

  .params-section:last-child { border-bottom: none; }

  .section-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 18px;
  }

  .field {
    margin-bottom: 16px;
  }

  .field:last-child { margin-bottom: 0; }

  label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-light);
    margin-bottom: 7px;
    letter-spacing: 0.01em;
  }

  input[type="number"] {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'Inter Display', 'Inter', sans-serif;
    font-size: 14px;
    padding: 10px 13px;
    outline: none;
    transition: border-color 0.15s;
    -moz-appearance: textfield;
  }

  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }

  input[type="number"]:focus {
    border-color: var(--accent);
    background: rgba(212,175,55,0.04);
  }

  .field-unit {
    display: flex;
    gap: 0;
  }

  .field-unit input {
    border-radius: var(--radius-sm) 0 0 var(--radius-sm);
    border-right: none;
  }

  .unit-badge {
    background: var(--border);
    border: 1px solid var(--border-light);
    border-left: none;
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    padding: 10px 12px;
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
    display: flex;
    align-items: center;
  }

  /* EINMALZAHLUNGEN */
  .einmal-row {
    display: grid;
    grid-template-columns: 1fr 1fr 28px;
    gap: 8px;
    margin-bottom: 8px;
    align-items: end;
  }

  .einmal-row label { margin-bottom: 5px; }

  .btn-remove {
    background: none;
    border: 1px solid var(--border-light);
    color: var(--text-muted);
    border-radius: 6px;
    width: 28px;
    height: 36px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
  }

  .btn-remove:hover {
    border-color: #ef4444;
    color: #ef4444;
    background: rgba(239,68,68,0.08);
  }

  .btn-add {
    background: none;
    border: 1px dashed var(--border-light);
    color: var(--text-muted);
    border-radius: var(--radius-sm);
    padding: 8px;
    width: 100%;
    cursor: pointer;
    font-size: 12px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    letter-spacing: 0.03em;
    transition: all 0.15s;
    margin-top: 4px;
  }

  .btn-add:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-dim);
  }

  /* CALC BUTTON */
  .btn-calc {
    width: 100%;
    background: var(--accent);
    color: #0a0a0a;
    border: none;
    border-radius: var(--radius-sm);
    padding: 14px;
    font-family: 'Inter Display', 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.04em;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
  }

  .btn-calc:hover {
    background: #4eeebb;
    transform: translateY(-1px);
    box-shadow: 0 8px 24px rgba(56,217,163,0.25);
  }

  .btn-calc:active { transform: translateY(0); }

  /* RIGHT PANEL */
  .results-panel {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  /* CHART */
  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .chart-header {
    padding: 24px 28px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }

  .chart-title {
    font-family: 'Inter Display', 'Inter', sans-serif;
    font-weight: 600;
    font-size: 22px;
    color: var(--text);
  }

  .legend {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 7px;
    padding: 5px 12px;
    border: 1px solid var(--border-light);
    border-radius: 100px;
    cursor: pointer;
    transition: all 0.15s;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-light);
    user-select: none;
  }

  .legend-item.active {
    border-color: transparent;
    color: var(--text);
  }

  .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .legend-item.active .legend-dot {
    box-shadow: 0 0 8px currentColor;
  }

  .legend-item.inactive {
    opacity: 0.4;
  }

  .chart-body {
    padding: 24px 16px 16px;
    height: 380px;
    position: relative;
  }

  /* SUMMARY CARDS */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
  }

  .summary-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 22px;
  }

  .summary-card.highlight {
    border-color: var(--accent);
    background: rgba(212,175,55,0.04);
  }

  .summary-label {
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 10px;
  }

  .summary-value {
    font-family: 'Inter Display', 'Inter', sans-serif;
    font-weight: 700;
    font-size: 28px;
    letter-spacing: -0.02em;
    line-height: 1;
    margin-bottom: 6px;
  }

  .summary-sub {
    font-size: 12px;
    color: var(--text-muted);
  }

  .badge-pos { color: var(--green); }
  .badge-neg { color: #f87171; }

  /* TABLE */
  .table-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .table-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .table-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
  }

  .table-wrap {
    overflow-x: auto;
    max-height: 340px;
    overflow-y: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  thead th {
    padding: 11px 16px;
    text-align: right;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-muted);
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    white-space: nowrap;
  }

  thead th:first-child { text-align: center; }

  tbody td {
    padding: 10px 16px;
    text-align: right;
    border-bottom: 1px solid var(--border);
    font-variant-numeric: tabular-nums;
    color: var(--text-light);
  }

  tbody td:first-child {
    text-align: center;
    color: var(--text-muted);
    font-weight: 500;
  }

  tbody tr:last-child td { border-bottom: none; }

  tbody tr:hover td {
    background: rgba(255,255,255,0.02);
    color: var(--text);
  }

  .td-green { color: var(--green) !important; }
  .td-blue { color: var(--blue) !important; }
  .td-orange { color: var(--orange) !important; }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  /* FOOTER */
  footer {
    border-top: 1px solid var(--border);
    padding: 28px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: var(--text-muted);
    font-size: 12px;
    max-width: 100%;
  }

  footer a {
    color: var(--text-muted);
    text-decoration: none;
    transition: color 0.15s;
  }

  footer a:hover { color: var(--accent); }

  @media (max-width: 900px) {
    header { padding: 18px 20px; }
    .hero { padding: 50px 20px 40px; }
    .main { grid-template-columns: 1fr; padding: 0 20px 60px; }
    .params-panel { position: static; top: auto; }
    .summary-grid { grid-template-columns: 1fr 1fr; }
    footer { padding: 20px; flex-direction: column; gap: 8px; text-align: center; }
  }

  @media (max-width: 600px) {
    .summary-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="hero">
  <div class="hero-label">Analyse-Tool</div>
  <h1>FLV vs. Flatex Depot —<br><em>Der direkte Vergleich</em></h1>
  <p>Alle Werte nach Steuern. Vergleiche Fondsgebundene Lebensversicherung mit einem thesaurierenden oder ausschüttenden Depot über deine individuelle Laufzeit.</p>
</div>

<div class="main">

  <!-- PARAMS -->
  <aside class="params-panel">

    <div class="params-section">
      <div class="section-label">Allgemeine Parameter</div>

      <div class="field">
        <label>Monatliche Sparrate</label>
        <div class="field-unit">
          <input type="number" id="monatsbeitrag" value="100" min="1" step="10">
          <span class="unit-badge">€ / Mo.</span>
        </div>
      </div>

      <div class="field">
        <label>Laufzeit</label>
        <div class="field-unit">
          <input type="number" id="laufzeit" value="40" min="1" max="50">
          <span class="unit-badge">Jahre</span>
        </div>
      </div>

      <div class="field">
        <label>Marktrendite p.a.</label>
        <div class="field-unit">
          <input type="number" id="rendite" value="6" min="0" max="30" step="0.1">
          <span class="unit-badge">% p.a.</span>
        </div>
      </div>
    </div>

    <div class="params-section">
      <div class="section-label">Sonderzahlungen (Einmalanlagen)</div>
      <div id="einmalzahlungen-container"></div>
      <button class="btn-add" onclick="addEinmal()">+ Einmalzahlung hinzufügen</button>
    </div>

    <div class="collapsible-trigger" onclick="toggleCollapsible(this)" id="trigger-flv">
      <div class="section-label">FLV — Kostenparameter</div>
      <span class="collapsible-arrow">▼</span>
    </div>
    <div class="collapsible-body" id="body-flv">

      <div class="field">
        <label>Agio Einmaleinlagen</label>
        <div class="field-unit">
          <input type="number" id="flv_agio" value="7.65" step="0.01" min="0">
          <span class="unit-badge">%</span>
        </div>
      </div>

      <div class="field">
        <label>Laufende Kosten auf Einmalanlagen p.a.</label>
        <div class="field-unit">
          <input type="number" id="flv_kosten" value="0.61" step="0.01" min="0">
          <span class="unit-badge">% p.a.</span>
        </div>
      </div>

    </div>

    <div class="collapsible-trigger" onclick="toggleCollapsible(this)" id="trigger-depot">
      <div class="section-label">Flatex Depot — Kostenparameter</div>
      <span class="collapsible-arrow">▼</span>
    </div>
    <div class="collapsible-body" id="body-depot">

      <div class="field">
        <label>Agio Depot</label>
        <div class="field-unit">
          <input type="number" id="depot_agio" value="0" step="0.1" min="0">
          <span class="unit-badge">%</span>
        </div>
      </div>

      <div class="field">
        <label>Sparplan-Ordergebühr</label>
        <div class="field-unit">
          <input type="number" id="depot_sparplan" value="1.50" step="0.10" min="0">
          <span class="unit-badge">€ / Order</span>
        </div>
      </div>

      <div class="field">
        <label>Einzelkauf-Ordergebühr</label>
        <div class="field-unit">
          <input type="number" id="depot_einzel" value="5.90" step="0.10" min="0">
          <span class="unit-badge">€ / Order</span>
        </div>
      </div>

      <div class="field">
        <label>TER (Fondskostenquote p.a.)</label>
        <div class="field-unit">
          <input type="number" id="depot_ter" value="0.30" step="0.01" min="0">
          <span class="unit-badge">% p.a.</span>
        </div>
      </div>

      <div class="field">
        <label>KESt (Kapitalertragsteuer)</label>
        <div class="field-unit">
          <input type="number" id="depot_kest" value="27.5" step="0.1" min="0" max="100">
          <span class="unit-badge">%</span>
        </div>
      </div>

      <div class="field">
        <label>Dividendenrendite p.a.</label>
        <div class="field-unit">
          <input type="number" id="depot_div" value="2" step="0.1" min="0">
          <span class="unit-badge">% p.a.</span>
        </div>
      </div>

      <div class="field">
        <label>Anteil ausschüttungsgleicher Erträge (AgE)</label>
        <div class="field-unit">
          <input type="number" id="depot_age" value="60" step="1" min="0" max="100">
          <span class="unit-badge">%</span>
        </div>
      </div>

    </div>

    <div class="params-section">
      <button class="btn-calc" onclick="berechne()">Berechnung starten</button>
    </div>

  </aside>

  <!-- RESULTS -->
  <div class="results-panel" id="results">

    <div class="summary-grid" id="summary-grid">
      <div class="summary-card">
        <div class="summary-label">FLV (Netto)</div>
        <div class="summary-value td-green" id="sum-flv">—</div>
        <div class="summary-sub">nach Kosten &amp; Steuer</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Depot Thesaurierend</div>
        <div class="summary-value td-blue" id="sum-thes">—</div>
        <div class="summary-sub">nach KESt bei Verkauf</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Depot Ausschüttend</div>
        <div class="summary-value td-orange" id="sum-ausch">—</div>
        <div class="summary-sub">nach KESt bei Verkauf</div>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">Kapitalentwicklung (nach Steuern)</div>
        <div class="legend" id="legend"></div>
      </div>
      <div class="chart-body">
        <canvas id="myChart"></canvas>
      </div>
    </div>

    <div class="table-card">
      <div class="table-header">
        <span class="table-title">Jahrestabelle — alle Werte nach Steuern</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Jahr</th>
              <th>Eingezahlt</th>
              <th style="color: var(--green)">FLV Netto</th>
              <th style="color: var(--blue)">Depot Thesaur.</th>
              <th style="color: var(--orange)">Depot Ausschütt.</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr><td colspan="5" style="text-align:center; padding: 40px; color: var(--text-muted);">Starte die Berechnung ↑</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<footer>
  <span>© 2026 Jason Schreiber · Vermögensberatung & Versicherungen Wien</span>
  <span>Alle Angaben ohne Gewähr · Kein Anlageberatungsersatz · <a href="https://jasonschreiber.at">jasonschreiber.at</a></span>
</footer>

<script>
function toggleCollapsible(trigger) {
  trigger.classList.toggle('open');
  const bodyId = trigger.id.replace('trigger-', 'body-');
  const body = document.getElementById(bodyId);
  body.classList.toggle('open');
}

// ========================
// EINMALZAHLUNGEN UI
// ========================
let einmalData = [
  { jahr: 0, betrag: 0 },
  { jahr: 1, betrag: 0 },
  { jahr: 2, betrag: 0 }
];

function renderEinmal() {
  const container = document.getElementById('einmalzahlungen-container');
  container.innerHTML = '';
  einmalData.forEach((e, i) => {
    const row = document.createElement('div');
    row.className = 'einmal-row';
    row.innerHTML = `
      <div>
        ${i === 0 ? '<label>Jahr</label>' : '<label>&nbsp;</label>'}
        <div class="field-unit">
          <input type="number" value="${e.jahr}" min="0" onchange="einmalData[${i}].jahr=+this.value" style="border-radius:6px 0 0 6px;border-right:none">
          <span class="unit-badge">J.</span>
        </div>
      </div>
      <div>
        ${i === 0 ? '<label>Betrag</label>' : '<label>&nbsp;</label>'}
        <div class="field-unit">
          <input type="number" value="${e.betrag}" min="0" step="100" onchange="einmalData[${i}].betrag=+this.value" style="border-radius:6px 0 0 6px;border-right:none">
          <span class="unit-badge">€</span>
        </div>
      </div>
      <div>
        ${i === 0 ? '<label>&nbsp;</label>' : ''}
        <button class="btn-remove" onclick="removeEinmal(${i})" title="Entfernen">×</button>
      </div>
    `;
    container.appendChild(row);
  });
}

function addEinmal() {
  einmalData.push({ jahr: 0, betrag: 0 });
  renderEinmal();
}

function removeEinmal(i) {
  einmalData.splice(i, 1);
  renderEinmal();
}

renderEinmal();

// ========================
// CHART
// ========================
let myChart = null;
let visibilityState = { flv: true, thes: true, ausch: true, einzahlt: true };

const COLORS = {
  flv:     '#4ade80',
  thes:    '#60a5fa',
  ausch:   '#fb923c',
  einzahlt:'#6b7280'
};

const LABELS = {
  flv:     'FLV Netto',
  thes:    'Depot Thesaurierend',
  ausch:   'Depot Ausschüttend',
  einzahlt:'Eingezahltes Kapital'
};

function buildLegend() {
  const legend = document.getElementById('legend');
  legend.innerHTML = '';
  Object.keys(COLORS).forEach(key => {
    const item = document.createElement('div');
    item.className = 'legend-item ' + (visibilityState[key] ? 'active' : 'inactive');
    item.style.color = visibilityState[key] ? COLORS[key] : 'var(--text-muted)';
    item.innerHTML = `<span class="legend-dot" style="background:${COLORS[key]}"></span>${LABELS[key]}`;
    item.addEventListener('click', () => {
      visibilityState[key] = !visibilityState[key];
      if (myChart) {
        const dsMap = { flv: 0, thes: 1, ausch: 2, einzahlt: 3 };
        const ds = myChart.data.datasets[dsMap[key]];
        ds.hidden = !visibilityState[key];
        myChart.update();
      }
      buildLegend();
    });
    legend.appendChild(item);
  });
}

buildLegend();

function renderChart(data) {
  const ctx = document.getElementById('myChart').getContext('2d');
  if (myChart) myChart.destroy();

  const labels = data.map(r => r.Jahr);

  myChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: LABELS.flv,
          data: data.map(r => r.FLV_Netto),
          borderColor: COLORS.flv,
          backgroundColor: 'rgba(74,222,128,0.06)',
          borderWidth: 2.5,
          tension: 0.4,
          pointRadius: 0,
          pointHoverRadius: 4,
          fill: false,
          hidden: !visibilityState.flv
        },
        {
          label: LABELS.thes,
          data: data.map(r => r.Depot_Thesaurierend_Netto),
          borderColor: COLORS.thes,
          backgroundColor: 'rgba(96,165,250,0.06)',
          borderWidth: 2.5,
          tension: 0.4,
          pointRadius: 0,
          pointHoverRadius: 4,
          fill: false,
          hidden: !visibilityState.thes
        },
        {
          label: LABELS.ausch,
          data: data.map(r => r.Depot_Ausschuettend_Netto),
          borderColor: COLORS.ausch,
          backgroundColor: 'rgba(251,146,60,0.06)',
          borderWidth: 2,
          borderDash: [5, 3],
          tension: 0.4,
          pointRadius: 0,
          pointHoverRadius: 4,
          fill: false,
          hidden: !visibilityState.ausch
        },
        {
          label: LABELS.einzahlt,
          data: data.map(r => r.Eingezahlt),
          borderColor: COLORS.einzahlt,
          backgroundColor: 'transparent',
          borderWidth: 1.5,
          borderDash: [6, 4],
          tension: 0,
          pointRadius: 0,
          fill: false,
          hidden: !visibilityState.einzahlt
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a1a1a',
          borderColor: '#2e2e2e',
          borderWidth: 1,
          padding: 12,
          titleColor: '#f0ede8',
          bodyColor: '#b0aa9f',
          callbacks: {
            label: ctx => ` ${ctx.dataset.label}: ${formatEur(ctx.parsed.y)}`
          }
        }
      },
      scales: {
        x: {
          grid: { color: 'rgba(255,255,255,0.04)', drawTicks: false },
          ticks: { color: '#7a7570', font: { size: 11 }, maxTicksLimit: 10 },
          border: { color: 'transparent' }
        },
        y: {
          grid: { color: 'rgba(255,255,255,0.04)', drawTicks: false },
          ticks: {
            color: '#7a7570',
            font: { size: 11 },
            callback: v => formatEurShort(v)
          },
          border: { color: 'transparent' }
        }
      }
    }
  });
}

// ========================
// MATH (1:1 from Python)
// ========================
function berechne() {
  const monatsbeitrag  = parseFloat(document.getElementById('monatsbeitrag').value);
  const laufzeit_jahre = parseInt(document.getElementById('laufzeit').value);
  const rendite_pa     = parseFloat(document.getElementById('rendite').value) / 100;
  const einmaleinlagen = einmalData.map(e => ({ jahr: parseInt(e.jahr), betrag: parseFloat(e.betrag) || 0 }));

  const flv_params = {
    agio_einmal:           parseFloat(document.getElementById('flv_agio').value) / 100,
    laufende_kosten_einmal: parseFloat(document.getElementById('flv_kosten').value) / 100
  };

  const depot_params = {
    agio:         parseFloat(document.getElementById('depot_agio').value) / 100,
    order_sparplan: parseFloat(document.getElementById('depot_sparplan').value),
    order_einmal:   parseFloat(document.getElementById('depot_einzel').value),
    ter:          parseFloat(document.getElementById('depot_ter').value) / 100,
    kest:         parseFloat(document.getElementById('depot_kest').value) / 100,
    div_rendite:  parseFloat(document.getElementById('depot_div').value) / 100,
    anteil_age:   parseFloat(document.getElementById('depot_age').value) / 100
  };

  const data = berechneVergleich(monatsbeitrag, laufzeit_jahre, rendite_pa, einmaleinlagen, flv_params, depot_params);

  renderChart(data);
  renderTable(data);
  renderSummary(data);
  buildLegend();
}

function berechneVergleich(monatsbeitrag, laufzeit_jahre, rendite_pa, einmaleinlagen, flv_params, depot_params) {

  const ref_rendite = 0.06;
  const q_ref = Math.pow(1 + ref_rendite, 1/12);

  function rentenwert_ref(m_rate, n_monate) {
    if (Math.abs(ref_rendite) < 1e-8) return m_rate * n_monate;
    return m_rate * ((Math.pow(q_ref, n_monate) - 1) / (q_ref - 1));
  }

  // Anchor tables (from Python)
  const basis_100_anker = {
    0: 0.0, 1: 618.06, 2: 1270.27, 3: 1961.42, 4: 2693.89, 5: 3470.10,
    10: 11062.82, 15: 21209.92, 20: 34766.96, 25: 52875.92, 30: 77060.00, 35: 109352.45, 40: 152464.60
  };
  const basis_500_anker = {
    0: 0.0, 1: 3204.64, 2: 6597.50, 3: 10192.99, 4: 14003.30, 5: 18041.10,
    10: 56149.33, 15: 108933.69, 20: 178401.14, 25: 271203.42, 30: 395157.38, 35: 560699.45
  };

  const q_flv = Math.pow(1 + rendite_pa, 1/12);
  const effektiv_zins_depot = rendite_pa - depot_params.ter;
  const q_depot = Math.pow(1 + effektiv_zins_depot, 1/12);

  function rentenwert_flv(m_rate, n_monate) {
    if (Math.abs(rendite_pa) < 1e-8) return m_rate * n_monate;
    return m_rate * ((Math.pow(q_flv, n_monate) - 1) / (q_flv - 1));
  }

  const ergebnisse = [];
  let kum_einmalzahlungen = 0;
  let kapital_flv_monatlich = 0.0;

  let kapital_t_brutto = 0.0;
  let basis_t = 0.0;
  let kapital_a_brutto = 0.0;
  let basis_a = 0.0;

  // Jahr 0 Einmalzahlungen
  for (const anlage of einmaleinlagen) {
    if (anlage.jahr <= 0) {
      kum_einmalzahlungen += anlage.betrag;
      basis_t += anlage.betrag;
      basis_a += anlage.betrag;
      const netto_depot = Math.max(0, anlage.betrag * (1 - depot_params.agio) - depot_params.order_einmal);
      kapital_t_brutto += netto_depot;
      kapital_a_brutto += netto_depot;
    }
  }

  for (let jahr = 1; jahr <= laufzeit_jahre; jahr++) {
    const monate_bisher = jahr * 12;

    // FLV block interpolation
    let block_start, block_end, anzahl_monate;
    if (jahr <= 5) {
      block_start = jahr - 1; block_end = jahr; anzahl_monate = 12;
    } else {
      block_start = Math.floor((jahr - 1) / 5) * 5;
      block_end = block_start + 5;
      anzahl_monate = 60;
    }

    const k_start_100 = basis_100_anker[block_start];
    const k_end_100   = basis_100_anker[block_end];
    const k_start_500 = basis_500_anker[block_start];
    const k_end_500   = basis_500_anker[block_end];

    function calc_m_rate(k_start, k_end) {
      return (k_end - k_start * Math.pow(q_ref, anzahl_monate)) / rentenwert_ref(1, anzahl_monate);
    }

    let m_100, m_500;
    if (k_end_100 !== undefined && k_end_500 !== undefined) {
      m_100 = calc_m_rate(k_start_100, k_end_100);
      m_500 = calc_m_rate(k_start_500, k_end_500);
    } else {
      m_100 = calc_m_rate(basis_100_anker[35], basis_100_anker[40]);
      m_500 = calc_m_rate(basis_500_anker[30], basis_500_anker[35]);
    }

    const m_aktuell = m_100 + (m_500 - m_100) * ((monatsbeitrag - 100) / 400.0);
    kapital_flv_monatlich = kapital_flv_monatlich * Math.pow(q_flv, 12) + rentenwert_flv(m_aktuell, 12);

    let kapital_flv_einmal = 0;

    // Sonderzahlungen
    for (const anlage of einmaleinlagen) {
      if (anlage.jahr === jahr) {
        kum_einmalzahlungen += anlage.betrag;
        basis_t += anlage.betrag;
        basis_a += anlage.betrag;
        const netto_depot = Math.max(0, anlage.betrag * (1 - depot_params.agio) - depot_params.order_einmal);
        kapital_t_brutto += netto_depot;
        kapital_a_brutto += netto_depot;
      }

      if (jahr >= anlage.jahr) {
        let jahre_seit_anlage;
        if (anlage.jahr > 0) {
          jahre_seit_anlage = jahr - anlage.jahr + 1;
        } else {
          jahre_seit_anlage = jahr;
        }
        const startwert = anlage.betrag * (1 - flv_params.agio_einmal);
        const kostendrag_faktor = (1 - flv_params.laufende_kosten_einmal);
        const rendite_faktor = (1 + rendite_pa);
        kapital_flv_einmal += startwert * Math.pow(kostendrag_faktor, jahre_seit_anlage) * Math.pow(rendite_faktor, jahre_seit_anlage);
      }
    }

    // Depot monatlich
    for (let monat = 1; monat <= 12; monat++) {
      basis_t += monatsbeitrag;
      basis_a += monatsbeitrag;
      const netto_sparplan = Math.max(0, monatsbeitrag * (1 - depot_params.agio) - depot_params.order_sparplan);
      kapital_t_brutto += netto_sparplan;
      kapital_a_brutto += netto_sparplan;
      kapital_t_brutto *= q_depot;
      kapital_a_brutto *= q_depot;
    }

    // Jahresende KESt (Österreich)
    const thesaurierungs_ertrag = kapital_t_brutto * depot_params.div_rendite;
    const steuer_t = thesaurierungs_ertrag * depot_params.anteil_age * depot_params.kest;
    kapital_t_brutto -= steuer_t;
    basis_t += thesaurierungs_ertrag * depot_params.anteil_age;

    const dividende_a = kapital_a_brutto * depot_params.div_rendite;
    const steuer_a = dividende_a * depot_params.kest;
    kapital_a_brutto -= steuer_a;
    basis_a += dividende_a - steuer_a;

    // Netto bei fiktivem Verkauf
    const flv_netto = kapital_flv_monatlich + kapital_flv_einmal;

    const gewinn_t = Math.max(0, kapital_t_brutto - basis_t);
    const depot_thesaur_netto = kapital_t_brutto - gewinn_t * depot_params.kest;

    const gewinn_a = Math.max(0, kapital_a_brutto - basis_a);
    const depot_aussch_netto = kapital_a_brutto - gewinn_a * depot_params.kest;

    const einzahlung_gesamt = monatsbeitrag * monate_bisher + kum_einmalzahlungen;

    ergebnisse.push({
      Jahr: jahr,
      Eingezahlt: einzahlung_gesamt,
      FLV_Netto: flv_netto,
      Depot_Thesaurierend_Netto: depot_thesaur_netto,
      Depot_Ausschuettend_Netto: depot_aussch_netto
    });
  }

  return ergebnisse;
}

// ========================
// RENDER HELPERS
// ========================
function formatEur(v) {
  return new Intl.NumberFormat('de-AT', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2 }).format(v);
}

function formatEurShort(v) {
  if (v >= 1e6) return (v / 1e6).toFixed(1) + ' M€';
  if (v >= 1e3) return (v / 1e3).toFixed(0) + ' K€';
  return v.toFixed(0) + ' €';
}

function renderSummary(data) {
  const last = data[data.length - 1];
  document.getElementById('sum-flv').textContent   = formatEur(last.FLV_Netto);
  document.getElementById('sum-thes').textContent  = formatEur(last.Depot_Thesaurierend_Netto);
  document.getElementById('sum-ausch').textContent = formatEur(last.Depot_Ausschuettend_Netto);

  // Highlight winner
  document.querySelectorAll('.summary-card').forEach(c => c.classList.remove('highlight'));
  const vals = [last.FLV_Netto, last.Depot_Thesaurierend_Netto, last.Depot_Ausschuettend_Netto];
  const maxIdx = vals.indexOf(Math.max(...vals));
  document.querySelectorAll('.summary-card')[maxIdx].classList.add('highlight');
}

function renderTable(data) {
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = '';
  data.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.Jahr}</td>
      <td>${formatEur(r.Eingezahlt)}</td>
      <td class="td-green">${formatEur(r.FLV_Netto)}</td>
      <td class="td-blue">${formatEur(r.Depot_Thesaurierend_Netto)}</td>
      <td class="td-orange">${formatEur(r.Depot_Ausschuettend_Netto)}</td>
    `;
    tbody.appendChild(tr);
  });
}

// Auto-calculate on load
window.addEventListener('DOMContentLoaded', () => berechne());
</script>

</body>
</html>