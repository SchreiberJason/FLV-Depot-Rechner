<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FLV vs. Depot Vergleichsrechner | Jason Schreiber</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,600&family=Inter+Display:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,700&display=swap" rel="stylesheet">
<style>
  /* ========== TOKENS ========== */
  :root[data-theme="dark"] {
    --surface-primary:   #0F0F0F;
    --surface-secondary: #16171B;
    --surface-tertiary:  #282930;
    --btn-primary:       #38D9A3;
    --btn-hover:         #2FC493;
    --btn-pressed:       #1C8764;
    --border:            #212430;
    --text-primary:      #F0EDE8;
    --text-secondary:    #969696;
    --text-muted:        #555860;
    --accent:            #38D9A3;
    --accent-dim:        rgba(56,217,163,0.08);
    --shadow:            rgba(0,0,0,0.45);
    --grid-line:         rgba(255,255,255,0.04);
  }

  :root[data-theme="light"] {
    --surface-primary:   #EDEBE5;
    --surface-secondary: #F7F2EA;
    --surface-tertiary:  #FFFEFC;
    --btn-primary:       #039F6B;
    --btn-hover:         #2FC493;
    --btn-pressed:       #1C8764;
    --border:            #DDD8CF;
    --text-primary:      #1A1A1A;
    --text-secondary:    #969696;
    --text-muted:        #AAAAAA;
    --accent:            #039F6B;
    --accent-dim:        rgba(3,159,107,0.08);
    --shadow:            rgba(0,0,0,0.07);
    --grid-line:         rgba(0,0,0,0.05);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--surface-primary);
    color: var(--text-primary);
    font-family: 'Inter Display', 'Inter', sans-serif;
    font-size: 15px;
    line-height: 1.6;
    min-height: 100vh;
    transition: background 0.2s, color 0.2s;
  }

  /* ========== THEME TOGGLE ========== */
  .theme-toggle {
    position: fixed;
    top: 18px;
    right: 18px;
    z-index: 200;
    background: var(--surface-secondary);
    border: 1px solid var(--border);
    border-radius: 100px;
    padding: 6px 13px 6px 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
    font-family: 'Inter Display', 'Inter', sans-serif;
    transition: all 0.15s;
    box-shadow: 0 2px 10px var(--shadow);
  }
  .theme-toggle:hover { color: var(--text-primary); border-color: var(--accent); }
  .theme-icon { font-size: 13px; }

  /* ========== LAYOUT ========== */
  .main {
    max-width: 1240px;
    margin: 0 auto;
    padding: 36px 28px 80px;
    display: grid;
    grid-template-columns: 360px 1fr;
    gap: 24px;
    align-items: start;
  }

  /* ========== PARAMS PANEL ========== */
  .params-panel {
    background: var(--surface-secondary);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    position: sticky;
    top: 20px;
    box-shadow: 0 4px 20px var(--shadow);
  }

  .params-section {
    padding: 18px 20px;
    border-bottom: 1px solid var(--border);
  }
  .params-section:last-child { border-bottom: none; }

  .section-label {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 14px;
  }

  /* ========== COLLAPSIBLE ========== */
  .collapsible-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    user-select: none;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }
  .collapsible-trigger:hover { background: var(--accent-dim); }
  .collapsible-trigger .section-label { margin-bottom: 0; }

  .collapsible-arrow {
    color: var(--text-muted);
    font-size: 9px;
    transition: transform 0.22s ease;
    flex-shrink: 0;
  }
  .collapsible-trigger.open .collapsible-arrow { transform: rotate(180deg); }

  .collapsible-body {
    display: none;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }
  .collapsible-body.open { display: block; }

  /* ========== FIELDS ========== */
  .field { margin-bottom: 13px; }
  .field:last-child { margin-bottom: 0; }

  label {
    display: block;
    font-size: 11.5px;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 5px;
  }

  input[type="number"] {
    width: 100%;
    background: var(--surface-tertiary);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-family: 'Inter Display', 'Inter', sans-serif;
    font-size: 14px;
    padding: 8px 11px;
    outline: none;
    transition: border-color 0.15s;
    -moz-appearance: textfield;
  }
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }
  input[type="number"]:focus { border-color: var(--accent); background: var(--accent-dim); }

  .field-unit { display: flex; }
  .field-unit input { border-radius: 8px 0 0 8px; border-right: none; }

  .unit-badge {
    background: var(--surface-primary);
    border: 1px solid var(--border);
    border-left: none;
    border-radius: 0 8px 8px 0;
    padding: 8px 10px;
    font-size: 11px;
    font-weight: 500;
    color: var(--text-muted);
    white-space: nowrap;
    display: flex;
    align-items: center;
  }

  /* ========== EINMAL ========== */
  .einmal-row {
    display: grid;
    grid-template-columns: 1fr 1fr 28px;
    gap: 7px;
    margin-bottom: 7px;
    align-items: end;
  }

  .btn-remove {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-muted);
    border-radius: 6px;
    width: 28px;
    height: 34px;
    cursor: pointer;
    font-size: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.13s;
  }
  .btn-remove:hover { border-color: #f87171; color: #f87171; background: rgba(248,113,113,0.08); }

  .btn-add {
    background: none;
    border: 1px dashed var(--border);
    color: var(--text-secondary);
    border-radius: 8px;
    padding: 7px;
    width: 100%;
    cursor: pointer;
    font-size: 12px;
    font-family: 'Inter Display', 'Inter', sans-serif;
    font-weight: 500;
    transition: all 0.13s;
    margin-top: 3px;
  }
  .btn-add:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }

  /* ========== CALC BTN ========== */
  .btn-calc {
    width: 100%;
    background: var(--btn-primary);
    color: #051a10;
    border: none;
    border-radius: 8px;
    padding: 12px;
    font-family: 'Inter Display', 'Inter', sans-serif;
    font-size: 12.5px;
    font-weight: 700;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    cursor: pointer;
    transition: background 0.13s, transform 0.1s, box-shadow 0.13s;
  }
  .btn-calc:hover { background: var(--btn-hover); transform: translateY(-1px); box-shadow: 0 6px 18px rgba(56,217,163,0.22); }
  .btn-calc:active { background: var(--btn-pressed); transform: translateY(0); box-shadow: none; }

  /* ========== RESULTS ========== */
  .results-panel { display: flex; flex-direction: column; gap: 18px; }

  /* ========== INSIGHT CARDS ========== */
  .insight-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 14px;
  }

  .insight-card {
    background: var(--surface-secondary);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 18px;
    box-shadow: 0 2px 10px var(--shadow);
  }
  .insight-card.accent-card { border-color: var(--accent); background: var(--accent-dim); }

  .insight-icon { font-size: 17px; margin-bottom: 9px; display: block; }

  .insight-label {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-secondary);
    margin-bottom: 7px;
  }

  .insight-value {
    font-family: 'Inter Display', 'Inter', sans-serif;
    font-weight: 700;
    font-size: 24px;
    letter-spacing: -0.02em;
    line-height: 1;
    margin-bottom: 7px;
    color: var(--text-primary);
  }
  .insight-value.accent   { color: var(--accent); }
  .insight-value.positive { color: #4ade80; }
  .insight-value.negative { color: #f87171; }

  .insight-sub { font-size: 11px; color: var(--text-secondary); line-height: 1.5; }

  /* ========== SUMMARY CARDS ========== */
  .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }

  .summary-card {
    background: var(--surface-secondary);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 18px;
    box-shadow: 0 2px 10px var(--shadow);
    transition: border-color 0.2s;
  }
  .summary-card.highlight { border-color: var(--accent); }

  .summary-label { font-size: 10px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 9px; }

  .summary-value { font-family: 'Inter Display', 'Inter', sans-serif; font-weight: 700; font-size: 24px; letter-spacing: -0.02em; line-height: 1; margin-bottom: 6px; }

  .summary-sub { font-size: 11px; color: var(--text-secondary); }

  .td-green  { color: #4ade80 !important; }
  .td-blue   { color: #60a5fa !important; }
  .td-orange { color: #fb923c !important; }

  /* ========== CHART ========== */
  .chart-card {
    background: var(--surface-secondary);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 2px 10px var(--shadow);
  }

  .chart-header {
    padding: 18px 22px 14px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
  }

  .chart-title { font-weight: 600; font-size: 15px; color: var(--text-primary); }

  .legend { display: flex; flex-wrap: wrap; gap: 5px; }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border: 1px solid var(--border);
    border-radius: 100px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 500;
    color: var(--text-secondary);
    background: var(--surface-tertiary);
    user-select: none;
    transition: all 0.13s;
  }
  .legend-item.active  { color: var(--text-primary); border-color: transparent; }
  .legend-item.inactive { opacity: 0.32; }

  .legend-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }

  .chart-body { padding: 18px 10px 12px; height: 350px; }

  /* ========== TABLE ========== */
  .table-card { background: var(--surface-secondary); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; box-shadow: 0 2px 10px var(--shadow); }
  .table-header { padding: 16px 20px; border-bottom: 1px solid var(--border); }
  .table-title { font-size: 13px; font-weight: 600; color: var(--text-primary); }
  .table-wrap { overflow-x: auto; max-height: 310px; overflow-y: auto; }

  table { width: 100%; border-collapse: collapse; font-size: 12.5px; }
  thead th { padding: 9px 13px; text-align: right; font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-secondary); background: var(--surface-tertiary); border-bottom: 1px solid var(--border); position: sticky; top: 0; white-space: nowrap; }
  thead th:first-child { text-align: center; }
  tbody td { padding: 9px 13px; text-align: right; border-bottom: 1px solid var(--border); font-variant-numeric: tabular-nums; color: var(--text-secondary); }
  tbody td:first-child { text-align: center; color: var(--text-muted); font-weight: 600; }
  tbody tr:last-child td { border-bottom: none; }
  tbody tr:hover td { background: var(--accent-dim); color: var(--text-primary); }

  /* ========== SCROLLBAR ========== */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* ========== FOOTER ========== */
  footer { border-top: 1px solid var(--border); padding: 22px 28px; display: flex; align-items: center; justify-content: space-between; color: var(--text-muted); font-size: 11px; }
  footer a { color: var(--text-muted); text-decoration: none; transition: color 0.13s; }
  footer a:hover { color: var(--accent); }

  /* ========== RESPONSIVE ========== */
  @media (max-width: 900px) {
    .main { grid-template-columns: 1fr; padding: 20px 14px 60px; }
    .params-panel { position: static; top: auto; }
    .summary-grid, .insight-grid { grid-template-columns: 1fr 1fr; }
    footer { padding: 16px 14px; flex-direction: column; gap: 6px; text-align: center; }
  }
  @media (max-width: 540px) {
    .summary-grid, .insight-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">
  <span class="theme-icon" id="themeIcon">‚òÄÔ∏è</span>
  <span id="themeLabel">Light Mode</span>
</button>

<div class="main">

  <!-- ===== PARAMS ===== -->
  <aside class="params-panel">

    <div class="params-section">
      <div class="section-label">Allgemeine Parameter</div>
      <div class="field">
        <label>Monatliche Sparrate</label>
        <div class="field-unit">
          <input type="number" id="monatsbeitrag" value="100" min="1" step="10">
          <span class="unit-badge">‚Ç¨ / Mo.</span>
        </div>
      </div>
      <div class="field">
        <label>Laufzeit</label>
        <div class="field-unit">
          <input type="number" id="laufzeit" value="40" min="1" max="50">
          <span class="unit-badge">Jahre</span>
        </div>
      </div>
      <div class="field">
        <label>Marktrendite p.a.</label>
        <div class="field-unit">
          <input type="number" id="rendite" value="6" min="0" max="30" step="0.1">
          <span class="unit-badge">% p.a.</span>
        </div>
      </div>
    </div>

    <div class="params-section">
      <div class="section-label">Sonderzahlungen (Einmalanlagen)</div>
      <div id="einmalzahlungen-container"></div>
      <button class="btn-add" onclick="addEinmal()">+ Einmalzahlung hinzuf√ºgen</button>
    </div>

    <!-- FLV collapsible -->
    <div class="collapsible-trigger" onclick="toggleCollapsible(this)" id="trigger-flv">
      <div class="section-label">FLV ‚Äî Kostenparameter</div>
      <span class="collapsible-arrow">‚ñº</span>
    </div>
    <div class="collapsible-body" id="body-flv">
      <div class="field">
        <label>Agio Einmaleinlagen</label>
        <div class="field-unit">
          <input type="number" id="flv_agio" value="7.65" step="0.01" min="0">
          <span class="unit-badge">%</span>
        </div>
      </div>
      <div class="field">
        <label>Laufende Kosten auf Einmalanlagen p.a.</label>
        <div class="field-unit">
          <input type="number" id="flv_kosten" value="0.61" step="0.01" min="0">
          <span class="unit-badge">% p.a.</span>
        </div>
      </div>
    </div>

    <!-- Depot collapsible -->
    <div class="collapsible-trigger" onclick="toggleCollapsible(this)" id="trigger-depot">
      <div class="section-label">Flatex Depot ‚Äî Kostenparameter</div>
      <span class="collapsible-arrow">‚ñº</span>
    </div>
    <div class="collapsible-body" id="body-depot">
      <div class="field">
        <label>Agio Depot</label>
        <div class="field-unit">
          <input type="number" id="depot_agio" value="0" step="0.1" min="0">
          <span class="unit-badge">%</span>
        </div>
      </div>
      <div class="field">
        <label>Sparplan-Ordergeb√ºhr</label>
        <div class="field-unit">
          <input type="number" id="depot_sparplan" value="1.50" step="0.10" min="0">
          <span class="unit-badge">‚Ç¨ / Order</span>
        </div>
      </div>
      <div class="field">
        <label>Einzelkauf-Ordergeb√ºhr</label>
        <div class="field-unit">
          <input type="number" id="depot_einzel" value="5.90" step="0.10" min="0">
          <span class="unit-badge">‚Ç¨ / Order</span>
        </div>
      </div>
      <div class="field">
        <label>TER (Fondskostenquote p.a.)</label>
        <div class="field-unit">
          <input type="number" id="depot_ter" value="0.30" step="0.01" min="0">
          <span class="unit-badge">% p.a.</span>
        </div>
      </div>
      <div class="field">
        <label>KESt (Kapitalertragsteuer)</label>
        <div class="field-unit">
          <input type="number" id="depot_kest" value="27.5" step="0.1" min="0" max="100">
          <span class="unit-badge">%</span>
        </div>
      </div>
      <div class="field">
        <label>Dividendenrendite p.a.</label>
        <div class="field-unit">
          <input type="number" id="depot_div" value="2" step="0.1" min="0">
          <span class="unit-badge">% p.a.</span>
        </div>
      </div>
      <div class="field">
        <label>Anteil aussch√ºttungsgleicher Ertr√§ge (AgE)</label>
        <div class="field-unit">
          <input type="number" id="depot_age" value="60" step="1" min="0" max="100">
          <span class="unit-badge">%</span>
        </div>
      </div>
    </div>

    <div class="params-section">
      <button class="btn-calc" onclick="berechne()">Berechnung starten</button>
    </div>

  </aside>

  <!-- ===== RESULTS ===== -->
  <div class="results-panel">

    <!-- Break-even + Delta insights -->
    <div class="insight-grid">
      <div class="insight-card accent-card">
        <span class="insight-icon">‚öñÔ∏è</span>
        <div class="insight-label">Break-even FLV vs. Thesaurierend</div>
        <div class="insight-value accent" id="breakeven-thes">‚Äî</div>
        <div class="insight-sub" id="breakeven-thes-sub">Ab diesem Jahr √ºberholt die FLV das Depot</div>
      </div>
      <div class="insight-card accent-card">
        <span class="insight-icon">‚öñÔ∏è</span>
        <div class="insight-label">Break-even FLV vs. Aussch√ºttend</div>
        <div class="insight-value accent" id="breakeven-ausch">‚Äî</div>
        <div class="insight-sub" id="breakeven-ausch-sub">Ab diesem Jahr √ºberholt die FLV das Depot</div>
      </div>
      <div class="insight-card">
        <span class="insight-icon">üìä</span>
        <div class="insight-label">FLV-Vorteil am Laufzeitende</div>
        <div class="insight-value" id="delta-best">‚Äî</div>
        <div class="insight-sub" id="delta-best-sub">Gegen√ºber bestem Depot-Ergebnis</div>
      </div>
    </div>

    <!-- Summary -->
    <div class="summary-grid">
      <div class="summary-card">
        <div class="summary-label">FLV (Netto)</div>
        <div class="summary-value td-green" id="sum-flv">‚Äî</div>
        <div class="summary-sub">nach Kosten &amp; Steuer</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Depot Thesaurierend</div>
        <div class="summary-value td-blue" id="sum-thes">‚Äî</div>
        <div class="summary-sub">nach KESt bei Verkauf</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Depot Aussch√ºttend</div>
        <div class="summary-value td-orange" id="sum-ausch">‚Äî</div>
        <div class="summary-sub">nach KESt bei Verkauf</div>
      </div>
    </div>

    <!-- Chart -->
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">Kapitalentwicklung (nach Steuern)</div>
        <div class="legend" id="legend"></div>
      </div>
      <div class="chart-body">
        <canvas id="myChart"></canvas>
      </div>
    </div>

    <!-- Table -->
    <div class="table-card">
      <div class="table-header">
        <span class="table-title">Jahrestabelle ‚Äî alle Werte nach Steuern</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Jahr</th>
              <th>Eingezahlt</th>
              <th style="color:#4ade80">FLV Netto</th>
              <th style="color:#60a5fa">Depot Thesaur.</th>
              <th style="color:#fb923c">Depot Aussch√ºtt.</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-muted)">Starte die Berechnung ‚Üê</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<footer>
  <span>¬© 2026 Jason Schreiber ¬∑ Verm√∂gensberatung &amp; Versicherungen Wien</span>
  <span>Alle Angaben ohne Gew√§hr ¬∑ Kein Anlageberatungsersatz ¬∑ <a href="https://jasonschreiber.at">jasonschreiber.at</a></span>
</footer>

<script>
// ========================
// THEME
// ========================
function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', isDark ? 'light' : 'dark');
  document.getElementById('themeIcon').textContent  = isDark ? 'üåô' : '‚òÄÔ∏è';
  document.getElementById('themeLabel').textContent = isDark ? 'Dark Mode' : 'Light Mode';
  if (lastData) renderChart(lastData);
}

// ========================
// COLLAPSIBLE
// ========================
function toggleCollapsible(trigger) {
  trigger.classList.toggle('open');
  const bodyId = trigger.id.replace('trigger-', 'body-');
  document.getElementById(bodyId).classList.toggle('open');
}

// ========================
// EINMALZAHLUNGEN
// ========================
let einmalData = [
  { jahr: 0, betrag: 0 },
  { jahr: 1, betrag: 0 },
  { jahr: 2, betrag: 0 }
];

function renderEinmal() {
  const container = document.getElementById('einmalzahlungen-container');
  container.innerHTML = '';
  einmalData.forEach((e, i) => {
    const row = document.createElement('div');
    row.className = 'einmal-row';
    row.innerHTML = `
      <div>
        ${i === 0 ? '<label>Jahr</label>' : '<label style="visibility:hidden">J</label>'}
        <div class="field-unit">
          <input type="number" value="${e.jahr}" min="0" onchange="einmalData[${i}].jahr=+this.value" style="border-radius:8px 0 0 8px;border-right:none">
          <span class="unit-badge">J.</span>
        </div>
      </div>
      <div>
        ${i === 0 ? '<label>Betrag</label>' : '<label style="visibility:hidden">B</label>'}
        <div class="field-unit">
          <input type="number" value="${e.betrag}" min="0" step="100" onchange="einmalData[${i}].betrag=+this.value" style="border-radius:8px 0 0 8px;border-right:none">
          <span class="unit-badge">‚Ç¨</span>
        </div>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn-remove" onclick="removeEinmal(${i})" title="Entfernen">√ó</button>
      </div>
    `;
    container.appendChild(row);
  });
}

function addEinmal()       { einmalData.push({ jahr: 0, betrag: 0 }); renderEinmal(); }
function removeEinmal(i)   { einmalData.splice(i, 1); renderEinmal(); }
renderEinmal();

// ========================
// CHART
// ========================
let myChart  = null;
let lastData = null;
let visibilityState = { flv: true, thes: true, ausch: true, einzahlt: true };

const COLORS = { flv: '#4ade80', thes: '#60a5fa', ausch: '#fb923c', einzahlt: '#555860' };
const LABELS = { flv: 'FLV Netto', thes: 'Depot Thesaurierend', ausch: 'Depot Aussch√ºttend', einzahlt: 'Eingezahltes Kapital' };

function buildLegend() {
  const legend = document.getElementById('legend');
  legend.innerHTML = '';
  Object.keys(COLORS).forEach(key => {
    const item = document.createElement('div');
    item.className = 'legend-item ' + (visibilityState[key] ? 'active' : 'inactive');
    item.style.color = visibilityState[key] ? COLORS[key] : 'var(--text-muted)';
    item.innerHTML = `<span class="legend-dot" style="background:${COLORS[key]}"></span>${LABELS[key]}`;
    item.addEventListener('click', () => {
      visibilityState[key] = !visibilityState[key];
      if (myChart) {
        const dsMap = { flv: 0, thes: 1, ausch: 2, einzahlt: 3 };
        myChart.data.datasets[dsMap[key]].hidden = !visibilityState[key];
        myChart.update();
      }
      buildLegend();
    });
    legend.appendChild(item);
  });
}
buildLegend();

function getTC() {
  const dark = document.documentElement.getAttribute('data-theme') === 'dark';
  return {
    grid:   dark ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.05)',
    ticks:  dark ? '#555860' : '#AAAAAA',
    ttBg:   dark ? '#16171B' : '#F7F2EA',
    ttBdr:  dark ? '#282930' : '#DEDAD3',
    ttTitle:dark ? '#F0EDE8' : '#1A1A1A',
    ttBody: '#969696'
  };
}

function renderChart(data) {
  if (myChart) myChart.destroy();
  const tc  = getTC();
  const ctx = document.getElementById('myChart').getContext('2d');

  myChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(r => r.Jahr),
      datasets: [
        { label: LABELS.flv,      data: data.map(r => r.FLV_Netto),                 borderColor: COLORS.flv,      backgroundColor: 'rgba(74,222,128,0.05)',  borderWidth: 2.5, tension: 0.4, pointRadius: 0, pointHoverRadius: 4, fill: false, hidden: !visibilityState.flv },
        { label: LABELS.thes,     data: data.map(r => r.Depot_Thesaurierend_Netto),  borderColor: COLORS.thes,     backgroundColor: 'rgba(96,165,250,0.05)',   borderWidth: 2.5, tension: 0.4, pointRadius: 0, pointHoverRadius: 4, fill: false, hidden: !visibilityState.thes },
        { label: LABELS.ausch,    data: data.map(r => r.Depot_Ausschuettend_Netto),  borderColor: COLORS.ausch,    backgroundColor: 'rgba(251,146,60,0.05)',   borderWidth: 2,   borderDash: [5,3], tension: 0.4, pointRadius: 0, pointHoverRadius: 4, fill: false, hidden: !visibilityState.ausch },
        { label: LABELS.einzahlt, data: data.map(r => r.Eingezahlt),                 borderColor: COLORS.einzahlt, backgroundColor: 'transparent',            borderWidth: 1.5, borderDash: [6,4], tension: 0, pointRadius: 0, fill: false, hidden: !visibilityState.einzahlt }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: tc.ttBg, borderColor: tc.ttBdr, borderWidth: 1,
          padding: 12, titleColor: tc.ttTitle, bodyColor: tc.ttBody,
          callbacks: { label: ctx => ` ${ctx.dataset.label}: ${formatEur(ctx.parsed.y)}` }
        }
      },
      scales: {
        x: { grid: { color: tc.grid, drawTicks: false }, ticks: { color: tc.ticks, font: { size: 11, family: 'Inter' }, maxTicksLimit: 10 }, border: { color: 'transparent' } },
        y: { grid: { color: tc.grid, drawTicks: false }, ticks: { color: tc.ticks, font: { size: 11, family: 'Inter' }, callback: v => formatEurShort(v) }, border: { color: 'transparent' } }
      }
    }
  });
}

// ========================
// MATH (1:1 from Python)
// ========================
function berechne() {
  const monatsbeitrag  = parseFloat(document.getElementById('monatsbeitrag').value);
  const laufzeit_jahre = parseInt(document.getElementById('laufzeit').value);
  const rendite_pa     = parseFloat(document.getElementById('rendite').value) / 100;
  const einmaleinlagen = einmalData.map(e => ({ jahr: parseInt(e.jahr), betrag: parseFloat(e.betrag) || 0 }));

  const flv_params = {
    agio_einmal:            parseFloat(document.getElementById('flv_agio').value) / 100,
    laufende_kosten_einmal: parseFloat(document.getElementById('flv_kosten').value) / 100
  };

  const depot_params = {
    agio:           parseFloat(document.getElementById('depot_agio').value) / 100,
    order_sparplan: parseFloat(document.getElementById('depot_sparplan').value),
    order_einmal:   parseFloat(document.getElementById('depot_einzel').value),
    ter:            parseFloat(document.getElementById('depot_ter').value) / 100,
    kest:           parseFloat(document.getElementById('depot_kest').value) / 100,
    div_rendite:    parseFloat(document.getElementById('depot_div').value) / 100,
    anteil_age:     parseFloat(document.getElementById('depot_age').value) / 100
  };

  const data = berechneVergleich(monatsbeitrag, laufzeit_jahre, rendite_pa, einmaleinlagen, flv_params, depot_params);
  lastData = data;

  renderChart(data);
  renderTable(data);
  renderSummary(data);
  renderInsights(data);
  buildLegend();
}

function berechneVergleich(monatsbeitrag, laufzeit_jahre, rendite_pa, einmaleinlagen, flv_params, depot_params) {
  const ref_rendite = 0.06;
  const q_ref = Math.pow(1 + ref_rendite, 1/12);

  function rentenwert_ref(m_rate, n_monate) {
    if (Math.abs(ref_rendite) < 1e-8) return m_rate * n_monate;
    return m_rate * ((Math.pow(q_ref, n_monate) - 1) / (q_ref - 1));
  }

  const basis_100_anker = { 0:0.0, 1:618.06, 2:1270.27, 3:1961.42, 4:2693.89, 5:3470.10, 10:11062.82, 15:21209.92, 20:34766.96, 25:52875.92, 30:77060.00, 35:109352.45, 40:152464.60 };
  const basis_500_anker = { 0:0.0, 1:3204.64, 2:6597.50, 3:10192.99, 4:14003.30, 5:18041.10, 10:56149.33, 15:108933.69, 20:178401.14, 25:271203.42, 30:395157.38, 35:560699.45 };

  const q_flv   = Math.pow(1 + rendite_pa, 1/12);
  const q_depot = Math.pow(1 + rendite_pa - depot_params.ter, 1/12);

  function rentenwert_flv(m_rate, n_monate) {
    if (Math.abs(rendite_pa) < 1e-8) return m_rate * n_monate;
    return m_rate * ((Math.pow(q_flv, n_monate) - 1) / (q_flv - 1));
  }

  const ergebnisse = [];
  let kum_einmalzahlungen = 0, kapital_flv_monatlich = 0.0;
  let kapital_t_brutto = 0.0, basis_t = 0.0, kapital_a_brutto = 0.0, basis_a = 0.0;

  for (const anlage of einmaleinlagen) {
    if (anlage.jahr <= 0) {
      kum_einmalzahlungen += anlage.betrag;
      basis_t += anlage.betrag; basis_a += anlage.betrag;
      const netto = Math.max(0, anlage.betrag * (1 - depot_params.agio) - depot_params.order_einmal);
      kapital_t_brutto += netto; kapital_a_brutto += netto;
    }
  }

  for (let jahr = 1; jahr <= laufzeit_jahre; jahr++) {
    let block_start, block_end, anzahl_monate;
    if (jahr <= 5) {
      block_start = jahr - 1; block_end = jahr; anzahl_monate = 12;
    } else {
      block_start = Math.floor((jahr - 1) / 5) * 5;
      block_end = block_start + 5; anzahl_monate = 60;
    }

    const ks100 = basis_100_anker[block_start], ke100 = basis_100_anker[block_end];
    const ks500 = basis_500_anker[block_start], ke500 = basis_500_anker[block_end];

    function calc_m_rate(ks, ke) {
      return (ke - ks * Math.pow(q_ref, anzahl_monate)) / rentenwert_ref(1, anzahl_monate);
    }

    let m_100, m_500;
    if (ke100 !== undefined && ke500 !== undefined) {
      m_100 = calc_m_rate(ks100, ke100); m_500 = calc_m_rate(ks500, ke500);
    } else {
      m_100 = calc_m_rate(basis_100_anker[35], basis_100_anker[40]);
      m_500 = calc_m_rate(basis_500_anker[30], basis_500_anker[35]);
    }

    const m_aktuell = m_100 + (m_500 - m_100) * ((monatsbeitrag - 100) / 400.0);
    kapital_flv_monatlich = kapital_flv_monatlich * Math.pow(q_flv, 12) + rentenwert_flv(m_aktuell, 12);

    let kapital_flv_einmal = 0;
    for (const anlage of einmaleinlagen) {
      if (anlage.jahr === jahr) {
        kum_einmalzahlungen += anlage.betrag;
        basis_t += anlage.betrag; basis_a += anlage.betrag;
        const netto = Math.max(0, anlage.betrag * (1 - depot_params.agio) - depot_params.order_einmal);
        kapital_t_brutto += netto; kapital_a_brutto += netto;
      }
      if (jahr >= anlage.jahr) {
        const jsa = anlage.jahr > 0 ? (jahr - anlage.jahr + 1) : jahr;
        kapital_flv_einmal += anlage.betrag * (1 - flv_params.agio_einmal)
          * Math.pow(1 - flv_params.laufende_kosten_einmal, jsa)
          * Math.pow(1 + rendite_pa, jsa);
      }
    }

    for (let m = 1; m <= 12; m++) {
      basis_t += monatsbeitrag; basis_a += monatsbeitrag;
      const ns = Math.max(0, monatsbeitrag * (1 - depot_params.agio) - depot_params.order_sparplan);
      kapital_t_brutto += ns; kapital_a_brutto += ns;
      kapital_t_brutto *= q_depot; kapital_a_brutto *= q_depot;
    }

    const th_ertrag = kapital_t_brutto * depot_params.div_rendite;
    const steuer_t  = th_ertrag * depot_params.anteil_age * depot_params.kest;
    kapital_t_brutto -= steuer_t;
    basis_t += th_ertrag * depot_params.anteil_age;

    const div_a    = kapital_a_brutto * depot_params.div_rendite;
    const steuer_a = div_a * depot_params.kest;
    kapital_a_brutto -= steuer_a;
    basis_a += div_a - steuer_a;

    const flv_netto           = kapital_flv_monatlich + kapital_flv_einmal;
    const depot_thesaur_netto = kapital_t_brutto - Math.max(0, kapital_t_brutto - basis_t) * depot_params.kest;
    const depot_aussch_netto  = kapital_a_brutto - Math.max(0, kapital_a_brutto - basis_a) * depot_params.kest;

    ergebnisse.push({
      Jahr: jahr,
      Eingezahlt: monatsbeitrag * (jahr * 12) + kum_einmalzahlungen,
      FLV_Netto: flv_netto,
      Depot_Thesaurierend_Netto: depot_thesaur_netto,
      Depot_Ausschuettend_Netto: depot_aussch_netto
    });
  }
  return ergebnisse;
}

// ========================
// RENDER HELPERS
// ========================
function formatEur(v) {
  return new Intl.NumberFormat('de-AT', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2 }).format(v);
}

function formatEurShort(v) {
  if (v >= 1e6) return (v / 1e6).toFixed(1) + ' M‚Ç¨';
  if (v >= 1e3) return (v / 1e3).toFixed(0) + ' K‚Ç¨';
  return v.toFixed(0) + ' ‚Ç¨';
}

function renderSummary(data) {
  const last = data[data.length - 1];
  document.getElementById('sum-flv').textContent   = formatEur(last.FLV_Netto);
  document.getElementById('sum-thes').textContent  = formatEur(last.Depot_Thesaurierend_Netto);
  document.getElementById('sum-ausch').textContent = formatEur(last.Depot_Ausschuettend_Netto);
  document.querySelectorAll('.summary-card').forEach(c => c.classList.remove('highlight'));
  const vals = [last.FLV_Netto, last.Depot_Thesaurierend_Netto, last.Depot_Ausschuettend_Netto];
  document.querySelectorAll('.summary-card')[vals.indexOf(Math.max(...vals))].classList.add('highlight');
}

function renderInsights(data) {
  const last = data[data.length - 1];

  // Break-even vs Thesaurierend
  let beThes = null;
  for (let i = 0; i < data.length; i++) {
    if (data[i].FLV_Netto >= data[i].Depot_Thesaurierend_Netto) { beThes = data[i].Jahr; break; }
  }
  if (beThes !== null) {
    document.getElementById('breakeven-thes').textContent = 'Jahr ' + beThes;
    document.getElementById('breakeven-thes-sub').textContent = `Ab Jahr ${beThes} liegt die FLV vorne`;
  } else {
    document.getElementById('breakeven-thes').textContent = 'Nie';
    document.getElementById('breakeven-thes-sub').textContent = 'FLV √ºberholt das Depot in dieser Laufzeit nicht';
  }

  // Break-even vs Aussch√ºttend
  let beAusch = null;
  for (let i = 0; i < data.length; i++) {
    if (data[i].FLV_Netto >= data[i].Depot_Ausschuettend_Netto) { beAusch = data[i].Jahr; break; }
  }
  if (beAusch !== null) {
    document.getElementById('breakeven-ausch').textContent = 'Jahr ' + beAusch;
    document.getElementById('breakeven-ausch-sub').textContent = `Ab Jahr ${beAusch} liegt die FLV vorne`;
  } else {
    document.getElementById('breakeven-ausch').textContent = 'Nie';
    document.getElementById('breakeven-ausch-sub').textContent = 'FLV √ºberholt das Depot in dieser Laufzeit nicht';
  }

  // Delta FLV vs best depot
  const bestDepot = Math.max(last.Depot_Thesaurierend_Netto, last.Depot_Ausschuettend_Netto);
  const bestName  = last.Depot_Thesaurierend_Netto >= last.Depot_Ausschuettend_Netto ? 'Thesaurierend' : 'Aussch√ºttend';
  const delta = last.FLV_Netto - bestDepot;
  const el    = document.getElementById('delta-best');
  el.textContent = (delta >= 0 ? '+' : '') + formatEur(delta);
  el.className   = 'insight-value ' + (delta >= 0 ? 'positive' : 'negative');
  document.getElementById('delta-best-sub').textContent = delta >= 0
    ? `FLV schl√§gt das beste Depot (${bestName}) um ${formatEur(delta)}`
    : `Depot ${bestName} schl√§gt die FLV um ${formatEur(Math.abs(delta))}`;
}

function renderTable(data) {
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = '';
  data.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.Jahr}</td>
      <td>${formatEur(r.Eingezahlt)}</td>
      <td class="td-green">${formatEur(r.FLV_Netto)}</td>
      <td class="td-blue">${formatEur(r.Depot_Thesaurierend_Netto)}</td>
      <td class="td-orange">${formatEur(r.Depot_Ausschuettend_Netto)}</td>
    `;
    tbody.appendChild(tr);
  });
}

window.addEventListener('DOMContentLoaded', () => berechne());
</script>
</body>
</html>